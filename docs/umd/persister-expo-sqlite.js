var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e="tinybase",s=",",n=t(""),i=(a,t)=>a.repeat(t),o=(a,t="")=>a.join(t),c=(a,t)=>a.map(t),r=a=>a.length,l=a=>0==r(a),y=(a,t)=>a.filter(t),w=(a,t,e)=>a.slice(t,e),E=(a,...t)=>a.push(...t),u=Promise,d=(a,t)=>a instanceof t,f=a=>null==a,p=(a,t,e)=>f(a)?e?.():t(a),T=a=>t(a)==n,m=async a=>u.all(a),v=(a,t)=>a?.has(t)??!1,A=a=>[...a?.values()??[]],L=(a,t)=>a?.delete(t),h=Object,N=h.keys,R=h.freeze,O=(a=[])=>h.fromEntries(a),S=(...a)=>h.assign({},...a),C=(a,t)=>c(h.entries(a),(([a,e])=>t(e,a))),b=a=>h.values(a),g=a=>r(N(a)),D=a=>(a=>d(a,h)&&a.constructor==h)(a)&&0==g(a),I=a=>new Map(a),F=a=>[...a?.keys()??[]],M=(a,t)=>a?.get(t),$=(a,t)=>c([...a?.entries()??[]],(([a,e])=>t(e,a))),P=(a,t,e)=>f(e)?(L(a,t),a):a?.set(t,e),x=(a,t,e)=>(v(a,t)||P(a,t,e()),M(a,t)),_=(a,t,e,s=P)=>(C(t,((t,s)=>e(a,s,t))),((a,t)=>{((a,t)=>{a?.forEach(t)})(a,((a,e)=>t(e)))})(a,(e=>((a,t)=>!f(((a,t)=>p(a,(a=>a[t])))(a,t)))(t,e)?0:s(a,e))),a),B=a=>new Set(Array.isArray(a)||f(a)?a:[a]),j=(a,t)=>a?.add(t),H="_",W="_id",q=a=>`"${a.replace(/"/g,'""')}"`,k="FROM pragma_table_",J="WHERE",U=(a,t,e)=>{const n=I();return[async()=>_(n,O(await m(c(await a("SELECT name "+k+"list WHERE schema='main'AND type='table'AND name IN("+z(t)+")",t),(async({name:t})=>[t,O(c(await a("SELECT name,type "+k+"info(?)",[t]),(({name:a,type:t})=>[a,t])))])))),((a,t,e)=>P(n,t,_(x(n,t,I),e,((a,t,e)=>{e!=M(a,t)&&P(a,t,e)}),((a,t)=>P(a,t))))),((a,t)=>P(n,t))),async(t,e)=>((a,t)=>!f(M(M(n,a),t)))(t,e)?O(y(c(await a("SELECT*FROM"+q(t)),(a=>{return[a[e],(t={...a},s=e,delete t[s],t)];var t,s})),(([a,t])=>!f(a)&&!D(t)))):{},async(t,e,i,r,w,u=!1)=>{const d=B();C(i??{},(a=>c(N(a??{}),(a=>j(d,a)))));const p=A(d);if(!u&&w&&l(p)&&v(n,t))return await a("DROP TABLE"+q(t)),void P(n,t);if(l(p)||v(n,t)){const s=M(n,t),i=B(F(s));await m([...c(p,(async e=>{L(i,e)||(await a(`ALTER TABLE${q(t)}ADD${q(e)}`),P(s,e,""))})),...!u&&r?c(A(i),(async n=>{n!=e&&(await a(`ALTER TABLE${q(t)}DROP${q(n)}`),P(s,n))})):[]])}else await a(`CREATE TABLE${q(t)}(${q(e)} PRIMARY KEY ON CONFLICT REPLACE${o(c(p,(a=>s+q(a))))});`),P(n,t,I([[e,""],...c(p,(a=>[a,""]))]));if(u)f(i)?await a("DELETE FROM"+q(t)+"WHERE 1"):await m(C(i,(async(s,n)=>{f(s)?await a("DELETE FROM"+q(t)+J+q(e)+"=?",[n]):l(p)||await Y(a,t,e,N(s),[n,...b(s)])})));else if(l(p))v(n,t)&&await a("DELETE FROM"+q(t)+"WHERE 1");else{const s=y(F(M(n,t)),(a=>a!=e)),o=[],r=[];C(i??{},((a,t)=>{E(o,t,...c(s,(t=>a?.[t]))),E(r,t)})),await Y(a,t,e,s,o),await a("DELETE FROM"+q(t)+J+q(e)+"NOT IN("+z(r)+")",r)}},async t=>{let s;await a("BEGIN");try{s=await t()}catch(a){e?.(a)}return await a("END"),s}]},Y=async(a,t,e,n,l)=>await a("INSERT INTO"+q(t)+"("+q(e)+o(c(n,(a=>s+q(a))))+")VALUES"+i(`,(?${i(",?",r(n))})`,r(l)/(r(n)+1)).substring(1)+"ON CONFLICT("+q(e)+")DO UPDATE SET"+o(c(n,(a=>q(a)+"=excluded."+q(a))),s),l),z=a=>o(c(a,(()=>"?")),s),G=JSON.parse,K=I(),V=I(),Q=(a,t,e,s,n,i,o=[])=>{let c,r,l,y=0,w=0;x(K,o,(()=>0)),x(V,o,(()=>[]));const u=async a=>(2!=y&&(y=1,await d.schedule((async()=>{await a(),y=0}))),d),d={load:async(e,s)=>await u((async()=>{try{a.setContent(await t())}catch{a.setContent([e,s])}})),startAutoLoad:async(e={},n={})=>(d.stopAutoLoad(),await d.load(e,n),w=1,l=s((async(e,s)=>{if(s){const t=s();await u((async()=>a.setTransactionChanges(t)))}else await u((async()=>{try{a.setContent(e?.()??await t())}catch(a){i?.(a)}}))})),d),stopAutoLoad:()=>(w&&(n(l),l=void 0,w=0),d),save:async t=>(1!=y&&(y=2,await d.schedule((async()=>{try{await e(a.getContent,t)}catch(a){i?.(a)}y=0}))),d),startAutoSave:async()=>(await d.stopAutoSave().save(),c=a.addDidFinishTransactionListener(((a,t)=>{const[e,s]=t();D(e)&&D(s)||d.save((()=>[e,s]))})),d),stopAutoSave:()=>(p(c,a.delListener),d),schedule:async(...a)=>(E(M(V,o),...a),await(async()=>{if(!M(K,o)){for(P(K,o,1);!f((a=M(V,o),r=a.shift()));)try{await r()}catch(a){i?.(a)}P(K,o,0)}var a})(),d),getStore:()=>a,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return R(d)},X="store",Z=(a,t,e,s,n,[i],o,c)=>{const[r,l,y,w]=U(t,o,n);return Q(a,(async()=>await w((async()=>(await r(),G((await l(i,W))[H]?.[X]??"null"))))),(async a=>await w((async()=>{var t;await r(),await y(i,W,{[H]:{[X]:(t=a()??null,JSON.stringify(t,((a,t)=>d(t,Map)?h.fromEntries([...t]):t)))}},!0,!0)}))),e,s,n,c)},aa=(a,t,e,s,n,[i,o,[c,r,l]],w,E)=>{const[u,d,p,T]=U(t,w,n),v=async(a,t)=>await m($(o,(async([e,s,n,i],o)=>{const c=a[o];t&&void 0===c||await p(e,s,c,n,i,t)}))),A=async(a,t)=>r?await p(l,W,{[H]:a},!0,!0,t):null;return Q(a,(async()=>await T((async()=>{await u();const a=await(async()=>O(y(await m($(i,(async([a,t],e)=>[a,await d(e,t)]))),(a=>!D(a[1])))))(),t=await(async()=>c?(await d(l,W))[H]:{})();return D(a)&&f(t)?void 0:[a,t]}))),(async(a,t)=>await T((async()=>{if(await u(),f(t)){const[t,e]=a();await v(t),await A(e)}else{const[a,e]=t();await v(a,!0),await A(e,!0)}}))),e,s,n,E)},ta="json",ea="autoLoadIntervalSeconds",sa="rowIdColumnName",na="tableId",ia="tableName",oa={mode:ta,[ea]:1},ca={load:0,save:0,[ia]:e+"_values"},ra=(a,t,e,s)=>{const n=I();return C(a,((a,i)=>{const o=w(b(S(t,T(a)?{[e]:a}:a)),0,g(t));f(o[0])||s(i,o[0])||P(n,i,o)})),n},la="pragma ",ya="data_version",wa="schema_version",Ea=(a,t,s,n,i,o,c,r)=>{let l,y;const[E,u,d,f]=(a=>{const t=(a=>S(oa,T(a)?{storeTableName:a}:a??{}))(a),s=t[ea];if(t.mode==ta){const{storeTableName:a=e}=t;return[1,s,[a],B(a)]}const{tables:{load:n={},save:i={}}={},values:o={}}=t,c=w(b(S(ca,o)),0,g(ca)),r=c[2],l=B(r);return[0,s,[ra(n,{[na]:null,[sa]:W},na,(a=>j(l,a)&&a==r)),ra(i,{[ia]:null,[sa]:W,deleteEmptyColumns:0,deleteEmptyTable:0},ia,((a,t)=>j(l,t)&&t==r)),c],l]})(t);return(E?Z:aa)(a,o?async(a,t)=>(o(a,t),await s(a,t)):s,(a=>[setInterval((async()=>{try{const t=(await s(la+ya))[0][ya],e=(await s(la+wa))[0][wa];t==(l??=t)&&e==(y??=e)||(a(),l=t,y=e)}catch{}}),1e3*u),n((t=>f.has(t)?a():0))]),(([a,t])=>{clearInterval(a),l=y=null,i(t)}),c,d,A(f),r)};a.createExpoSqlitePersister=(a,t,e,s,n)=>Ea(a,e,(async(a,e=[])=>(await t.execAsync([{sql:a,args:e}],!1))[0].rows),(a=>t.onDatabaseChange((({tableName:t})=>a(t)))),(a=>a.remove()),s,n,t)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterExpoSqlite={});
