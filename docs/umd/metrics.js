var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s=t(""),n=t(t),i=(e,t)=>e.forEach(t),o=e=>c(e,((e,t)=>e+t),0),r=e=>e.length,d=e=>0==r(e),c=(e,t,s)=>e.reduce(t,s),a=e=>e.slice(1),l=Math.max,u=Math.min,f=isFinite,h=e=>null==e,p=(e,t,s)=>h(e)?s?.():t(e),v=()=>{},g=e=>e.size,M=(e,t)=>e?.has(t)??!1,y=e=>e.clear(),b=(e,t)=>e?.forEach(t),m=(e,t)=>e?.delete(t),w=e=>new Map(e),L=(e,t)=>e?.get(t),T=(e,t)=>b(e,((e,s)=>t(s,e))),x=(e,t,s)=>h(s)?(m(e,t),e):e?.set(t,s),j=(e,t,s,n)=>(M(e,t)||(n?.(s),e.set(t,s)),L(e,t)),I=e=>new Set(e),R=(e,n)=>t(e)==s?t=>t(e):e??(()=>n??""),S=(e,t,s)=>r(s)<2?((e,t)=>e?.add(t))(d(s)?e:j(e,s[0],I()),t):S(j(e,s[0],w()),t,a(s)),k=e=>{const t=(s,n,...o)=>p(s,(s=>d(o)?e(s,n):i([o[0],null],(e=>t(L(s,e),n,...a(o))))));return t},z=Object.freeze,D=w([["avg",[(e,t)=>o(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>l(...e),(e,t)=>l(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:l(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:u(t,e)]],["sum",[e=>o(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),E=(e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))})((e=>{const s=w(),[o,d,c,a,l,u,j,E,N]=((e,t,s)=>{const n=e.hasRow,o=w(),r=w(),d=w(),c=w(),a=w(),l=t=>p(L(a,t),(s=>{b(s,e.delListener),x(a,t)})),u=e=>{x(o,e),x(r,e),x(d,e),x(c,e),l(e)};return[()=>e,()=>[...o?.keys()??[]],e=>M(r,e),e=>L(o,e),e=>L(r,e),(e,t)=>x(r,e,t),(u,f,p,v,g)=>{const m=w(),j=w();x(o,u,f),M(r,u)||(x(r,u,t()),x(d,u,w()),x(c,u,w()));const R=L(d,u),S=L(c,u),k=t=>{const i=s=>e.getCell(f,t,s),o=L(R,t),r=n(f,t)?s(v(i,t)):void 0;if(o!=r&&x(m,t,[o,r]),!h(g)){const e=L(S,t),s=n(f,t)?g(i,t):void 0;e!=s&&x(j,t,s)}},z=e=>{p((()=>{b(m,(([,e],t)=>x(R,t,e))),b(j,((e,t)=>x(S,t,e)))}),m,j,R,S,e),y(m),y(j)};T(R,k),e.hasTable(f)&&i(e.getRowIds(f),(e=>{M(R,e)||k(e)})),z(!0),l(u),x(a,u,I([e.addRowListener(f,null,((e,t,s)=>k(s))),e.addTableListener(f,(()=>z()))]))},u,()=>T(a,u)]})(e,v,(e=>isNaN(e)||h(e)||!0===e||!1===e||""===e?void 0:1*e)),[O,_,B]=(e=>{let t,s=0;const n=[],o=w();return[(i,r,d=[])=>{t??=e();const c=n.pop()??""+s++;return x(o,c,[i,r,d]),S(r,c,d),c},(e,s=[],...n)=>k(b)(e,(e=>p(L(o,e),(([e])=>e(t,...s,...n)))),...s),e=>p(L(o,e),(([,t,s])=>(k(m)(t,e,...s),x(o,e),r(n)<1e3&&n.push(e),s)),(()=>[])),(e,s,n)=>p(L(o,e),(([e,,o])=>{const d=(...c)=>{const a=r(c);a==r(o)?e(t,...c,...n(c)):h(o[a])?i(s[a](...c),(e=>d(...c,e))):d(...c,o[a])};d()}))]})((()=>C)),C={setMetricDefinition:(e,i,o,r,d,c,a)=>{const p=t(o)==n?[o,d,c,a]:L(D,o)??L(D,"sum");return j(e,i,((t,n,i,o,r,d)=>{let c=l(e),a=g(o);const[v,M,y,m]=p;var w;d=d||h(c),b(n,(([e,t])=>{d||(c=h(e)?M?.(c,t,a++):h(t)?y?.(c,e,a--):m?.(c,t,e,a)),d=d||h(c)})),t(),h(w=o)||0==g(w)?c=void 0:d&&(c=v((e=>[...e?.values()??[]])(o),g(o))),f(c)||(c=void 0);const L=l(e);c!=L&&(u(e,c),_(s,[e],c,L))}),R(r,1)),C},delMetricDefinition:e=>(E(e),C),getStore:o,getMetricIds:d,hasMetric:c,getTableId:a,getMetric:l,addMetricListener:(e,t)=>O(t,s,[e]),delListener:e=>(B(e),C),destroy:N,getListenerStats:()=>({})};return z(C)}));e.createMetrics=E,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
