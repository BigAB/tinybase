var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(t),o=(e,t)=>e.forEach(t),i=e=>c(e,((e,t)=>e+t),0),r=e=>e.length,d=e=>0==r(e),c=(e,t,n)=>e.reduce(t,n),a=e=>e.slice(1),l=Math.max,u=Math.min,f=isFinite,p=e=>null==e,v=(e,t,n)=>p(e)?n?.():t(e),g=()=>{},h=e=>e.size,M=(e,t)=>e?.has(t)??!1,y=e=>e.clear(),b=(e,t)=>e?.forEach(t),m=(e,t)=>e?.delete(t),w=e=>new Map(e),L=(e,t)=>e?.get(t),T=(e,t)=>b(e,((e,n)=>t(n,e))),x=(e,t,n)=>p(n)?(m(e,t),e):e?.set(t,n),j=(e,t,n,s)=>(M(e,t)||(s?.(n),e.set(t,n)),L(e,t)),I=e=>new Set(e),R=(e,s)=>t(e)==n?t=>t(e):e??(()=>s??""),S=(e,t,n)=>r(n)<2?((e,t)=>e?.add(t))(d(n)?e:j(e,n[0],I()),t):S(j(e,n[0],w()),t,a(n)),k=e=>{const t=(n,s,...i)=>v(n,(n=>d(i)?e(n,s):o([i[0],null],(e=>t(L(n,e),s,...a(i))))));return t},z=Object.freeze,D=w([["avg",[(e,t)=>i(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>l(...e),(e,t)=>l(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:l(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["sum",[e=>i(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),E=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const n=w(),[i,d,c,a,l,u,j,E]=((e,t,n)=>{const s=e.hasRow,i=w(),r=w(),d=w(),c=w(),a=w(),l=t=>v(L(a,t),(n=>{b(n,e.delListener),x(a,t)})),u=e=>{x(i,e),x(r,e),x(d,e),x(c,e),l(e)};return[()=>e,()=>[...i?.keys()??[]],e=>L(i,e),e=>L(r,e),(e,t)=>x(r,e,t),(u,f,v,g,h)=>{const m=w(),j=w();x(i,u,f),M(r,u)||(x(r,u,t()),x(d,u,w()),x(c,u,w()));const R=L(d,u),S=L(c,u),k=t=>{const o=n=>e.getCell(f,t,n),i=L(R,t),r=s(f,t)?n(g(o,t)):void 0;if(i!=r&&x(m,t,[i,r]),!p(h)){const e=L(S,t),n=s(f,t)?h(o,t):void 0;e!=n&&x(j,t,n)}},z=e=>{v((()=>{b(m,(([,e],t)=>x(R,t,e))),b(j,((e,t)=>x(S,t,e)))}),m,j,R,S,e),y(m),y(j)};T(R,k),e.hasTable(f)&&o(e.getRowIds(f),(e=>{M(R,e)||k(e)})),z(!0),l(u),x(a,u,I([e.addRowListener(f,null,((e,t,n)=>k(n))),e.addTableListener(f,(()=>z()))]))},u,()=>T(a,u)]})(e,g,(e=>isNaN(e)||p(e)||!0===e||!1===e||""===e?void 0:1*e)),[N,O,_]=(e=>{let t,n=0;const s=[],i=w();return[(o,r,d=[])=>{t??=e();const c=s.pop()??""+n++;return x(i,c,[o,r,d]),S(r,c,d),c},(e,n=[],...s)=>k(b)(e,(e=>v(L(i,e),(([e])=>e(t,...n,...s)))),...n),e=>v(L(i,e),(([,t,n])=>(k(m)(t,e,...n),x(i,e),r(s)<1e3&&s.push(e),n)),(()=>[])),(e,n,s)=>v(L(i,e),(([e,,i])=>{const d=(...c)=>{const a=r(c);a==r(i)?e(t,...c,...s(c)):p(i[a])?o(n[a](...c),(e=>d(...c,e))):d(...c,i[a])};d()}))]})((()=>B)),B={setMetricDefinition:(e,o,i,r,d,c,v)=>{const g=t(i)==s?[i,d,c,v]:L(D,i)??L(D,"sum");return u(e,o,((t,s,o,i,r,d)=>{let c=a(e),u=h(i);const[v,M,y,m]=g;var w;d=d||p(c),b(s,(([e,t])=>{d||(c=p(e)?M?.(c,t,u++):p(t)?y?.(c,e,u--):m?.(c,t,e,u)),d=d||p(c)})),t(),p(w=i)||0==h(w)?c=void 0:d&&(c=v((e=>[...e?.values()??[]])(i),h(i))),f(c)||(c=void 0);const L=a(e);c!=L&&(l(e,c),O(n,[e],c,L))}),R(r,1)),B},delMetricDefinition:e=>(j(e),B),getStore:i,getMetricIds:d,getTableId:c,getMetric:a,addMetricListener:(e,t)=>N(t,n,[e]),delListener:e=>(_(e),B),destroy:E,getListenerStats:()=>({})};return z(B)}));e.createMetrics=E,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
