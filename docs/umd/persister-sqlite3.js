var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e="tinybase",s=",",n=t(""),i=(a,t)=>a.repeat(t),c=(a,t="")=>a.join(t),o=(a,t)=>a.map(t),r=a=>a.length,l=a=>0==r(a),y=(a,t)=>a.filter(t),w=(a,t,e)=>a.slice(t,e),u=(a,...t)=>a.push(...t),E=Promise,d=(a,t)=>a instanceof t,f=a=>null==a,p=(a,t,e)=>f(a)?e?.():t(a),T=a=>t(a)==n,m=async a=>E.all(a),v=(a,t)=>a?.has(t)??!1,A=a=>[...a?.values()??[]],L=(a,t)=>a?.delete(t),h=Object,N=h.keys,R=h.freeze,O=(a=[])=>h.fromEntries(a),S=(...a)=>h.assign({},...a),C=(a,t)=>o(h.entries(a),(([a,e])=>t(e,a))),g=a=>h.values(a),b=a=>r(N(a)),D=a=>(a=>d(a,h)&&a.constructor==h)(a)&&0==b(a),I=a=>new Map(a),F=a=>[...a?.keys()??[]],M=(a,t)=>a?.get(t),$=(a,t)=>o([...a?.entries()??[]],(([a,e])=>t(e,a))),P=(a,t,e)=>f(e)?(L(a,t),a):a?.set(t,e),_=(a,t,e)=>(v(a,t)||P(a,t,e()),M(a,t)),B=(a,t,e,s=P)=>(C(t,((t,s)=>e(a,s,t))),((a,t)=>{((a,t)=>{a?.forEach(t)})(a,((a,e)=>t(e)))})(a,(e=>((a,t)=>!f(((a,t)=>p(a,(a=>a[t])))(a,t)))(t,e)?0:s(a,e))),a),j=a=>new Set(Array.isArray(a)||f(a)?a:[a]),x=(a,t)=>a?.add(t),H="_",W="_id",k=a=>`"${a.replace(/"/g,'""')}"`,q="FROM pragma_table_",J="WHERE",U=(a,t,e)=>{const n=I();return[async()=>B(n,O(await m(o(await a("SELECT name "+q+"list WHERE schema='main'AND type='table'AND name IN("+z(t)+")",t),(async({name:t})=>[t,O(o(await a("SELECT name,type "+q+"info(?)",[t]),(({name:a,type:t})=>[a,t])))])))),((a,t,e)=>P(n,t,B(_(n,t,I),e,((a,t,e)=>{e!=M(a,t)&&P(a,t,e)}),((a,t)=>P(a,t))))),((a,t)=>P(n,t))),async(t,e)=>((a,t)=>!f(M(M(n,a),t)))(t,e)?O(y(o(await a("SELECT*FROM"+k(t)),(a=>{return[a[e],(t={...a},s=e,delete t[s],t)];var t,s})),(([a,t])=>!f(a)&&!D(t)))):{},async(t,e,i,r,w,E=!1)=>{const d=j();C(i??{},(a=>o(N(a??{}),(a=>x(d,a)))));const p=A(d);if(!E&&w&&l(p)&&v(n,t))return await a("DROP TABLE"+k(t)),void P(n,t);if(l(p)||v(n,t)){const s=M(n,t),i=j(F(s));await m([...o(p,(async e=>{L(i,e)||(await a(`ALTER TABLE${k(t)}ADD${k(e)}`),P(s,e,""))})),...!E&&r?o(A(i),(async n=>{n!=e&&(await a(`ALTER TABLE${k(t)}DROP${k(n)}`),P(s,n))})):[]])}else await a(`CREATE TABLE${k(t)}(${k(e)} PRIMARY KEY ON CONFLICT REPLACE${c(o(p,(a=>s+k(a))))});`),P(n,t,I([[e,""],...o(p,(a=>[a,""]))]));if(E)f(i)?await a("DELETE FROM"+k(t)+"WHERE 1"):await m(C(i,(async(s,n)=>{f(s)?await a("DELETE FROM"+k(t)+J+k(e)+"=?",[n]):l(p)||await Y(a,t,e,N(s),[n,...g(s)])})));else if(l(p))v(n,t)&&await a("DELETE FROM"+k(t)+"WHERE 1");else{const s=y(F(M(n,t)),(a=>a!=e)),c=[],r=[];C(i??{},((a,t)=>{u(c,t,...o(s,(t=>a?.[t]))),u(r,t)})),await Y(a,t,e,s,c),await a("DELETE FROM"+k(t)+J+k(e)+"NOT IN("+z(r)+")",r)}},async t=>{let s;await a("BEGIN");try{s=await t()}catch(a){e?.(a)}return await a("END"),s}]},Y=async(a,t,e,n,l)=>await a("INSERT INTO"+k(t)+"("+k(e)+c(o(n,(a=>s+k(a))))+")VALUES"+i(`,(?${i(",?",r(n))})`,r(l)/(r(n)+1)).substring(1)+"ON CONFLICT("+k(e)+")DO UPDATE SET"+c(o(n,(a=>k(a)+"=excluded."+k(a))),s),l),z=a=>c(o(a,(()=>"?")),s),G=JSON.parse,K=I(),V=I(),Q=(a,t,e,s,n,i,c=[])=>{let o,r,l,y=0,w=0;_(K,c,(()=>0)),_(V,c,(()=>[]));const E=async a=>(2!=y&&(y=1,await d.schedule((async()=>{await a(),y=0}))),d),d={load:async(e,s)=>await E((async()=>{try{a.setContent(await t())}catch{a.setContent([e,s])}})),startAutoLoad:async(e={},n={})=>(d.stopAutoLoad(),await d.load(e,n),w=1,l=s((async(e,s)=>{if(s){const t=s();await E((async()=>a.setTransactionChanges(t)))}else await E((async()=>{try{a.setContent(e?.()??await t())}catch(a){i?.(a)}}))})),d),stopAutoLoad:()=>(w&&(n(l),l=void 0,w=0),d),save:async t=>(1!=y&&(y=2,await d.schedule((async()=>{try{await e(a.getContent,t)}catch(a){i?.(a)}y=0}))),d),startAutoSave:async()=>(await d.stopAutoSave().save(),o=a.addDidFinishTransactionListener(((a,t)=>{const[e,s]=t();D(e)&&D(s)||d.save((()=>[e,s]))})),d),stopAutoSave:()=>(p(o,a.delListener),d),schedule:async(...a)=>(u(M(V,c),...a),await(async()=>{if(!M(K,c)){for(P(K,c,1);!f((a=M(V,c),r=a.shift()));)try{await r()}catch(a){i?.(a)}P(K,c,0)}var a})(),d),getStore:()=>a,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return R(d)},X="store",Z=(a,t,e,s,n,[i],c,o)=>{const[r,l,y,w]=U(t,c,n);return Q(a,(async()=>await w((async()=>(await r(),G((await l(i,W))[H]?.[X]??"null"))))),(async a=>await w((async()=>{var t;await r(),await y(i,W,{[H]:{[X]:(t=a()??null,JSON.stringify(t,((a,t)=>d(t,Map)?h.fromEntries([...t]):t)))}},!0,!0)}))),e,s,n,o)},aa=(a,t,e,s,n,[i,c,[o,r,l]],w,u)=>{const[E,d,p,T]=U(t,w,n),v=async(a,t)=>await m($(c,(async([e,s,n,i],c)=>{const o=a[c];t&&void 0===o||await p(e,s,o,n,i,t)}))),A=async(a,t)=>r?await p(l,W,{[H]:a},!0,!0,t):null;return Q(a,(async()=>await T((async()=>{await E();const a=await(async()=>O(y(await m($(i,(async([a,t],e)=>[a,await d(e,t)]))),(a=>!D(a[1])))))(),t=await(async()=>o?(await d(l,W))[H]:{})();return D(a)&&f(t)?void 0:[a,t]}))),(async(a,t)=>await T((async()=>{if(await E(),f(t)){const[t,e]=a();await v(t),await A(e)}else{const[a,e]=t();await v(a,!0),await A(e,!0)}}))),e,s,n,u)},ta="json",ea="autoLoadIntervalSeconds",sa="rowIdColumnName",na="tableId",ia="tableName",ca={mode:ta,[ea]:1},oa={load:0,save:0,[ia]:e+"_values"},ra=(a,t,e,s)=>{const n=I();return C(a,((a,i)=>{const c=w(g(S(t,T(a)?{[e]:a}:a)),0,b(t));f(c[0])||s(i,c[0])||P(n,i,c)})),n},la="pragma ",ya="data_version",wa="schema_version",ua=(a,t,s,n,i,c,o,r)=>{let l,y;const[u,E,d,f]=(a=>{const t=(a=>S(ca,T(a)?{storeTableName:a}:a??{}))(a),s=t[ea];if(t.mode==ta){const{storeTableName:a=e}=t;return[1,s,[a],j(a)]}const{tables:{load:n={},save:i={}}={},values:c={}}=t,o=w(g(S(oa,c)),0,b(oa)),r=o[2],l=j(r);return[0,s,[ra(n,{[na]:null,[sa]:W},na,(a=>x(l,a)&&a==r)),ra(i,{[ia]:null,[sa]:W,deleteEmptyColumns:0,deleteEmptyTable:0},ia,((a,t)=>x(l,t)&&t==r)),o],l]})(t);return(u?Z:aa)(a,c?async(a,t)=>(c(a,t),await s(a,t)):s,(a=>[setInterval((async()=>{try{const t=(await s(la+ya))[0][ya],e=(await s(la+wa))[0][wa];t==(l??=t)&&e==(y??=e)||(a(),l=t,y=e)}catch{}}),1e3*E),n((t=>f.has(t)?a():0))]),(([a,t])=>{clearInterval(a),l=y=null,i(t)}),o,d,A(f),r)},Ea="change";a.createSqlite3Persister=(a,t,e,s,n)=>ua(a,e,(async(a,e=[])=>{return await(s=(s,n)=>t.all(a,e,((a,t)=>a?n(a):s(t.map((a=>({...a})))))),new E(s));var s}),(a=>{const e=(t,e,s)=>a(s);return t.on(Ea,e),e}),(a=>t.off(Ea,a)),s,n,t)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterSqlite3={});
