var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e="tinybase",s=",",n=t(""),i=(a,t)=>a.repeat(t),o=(a,t="")=>a.join(t),c=(a,t)=>a.map(t),r=a=>a.length,l=a=>0==r(a),y=(a,t)=>a.filter(t),w=(a,t,e)=>a.slice(t,e),u=(a,...t)=>a.push(...t),d=Promise,E=(a,t)=>a instanceof t,p=a=>null==a,f=(a,t,e)=>p(a)?e?.():t(a),m=a=>t(a)==n,T=async a=>d.all(a),v=(a,t)=>a?.has(t)??!1,h=a=>[...a?.values()??[]],A=(a,t)=>a?.delete(t),L=Object,R=L.keys,N=L.freeze,O=(a=[])=>L.fromEntries(a),S=(...a)=>L.assign({},...a),b=(a,t)=>c(L.entries(a),(([a,e])=>t(e,a))),C=a=>L.values(a),g=a=>r(R(a)),D=a=>(a=>E(a,L)&&a.constructor==L)(a)&&0==g(a),I=a=>new Map(a),_=a=>[...a?.keys()??[]],M=(a,t)=>a?.get(t),F=(a,t)=>c([...a?.entries()??[]],(([a,e])=>t(e,a))),$=(a,t,e)=>p(e)?(A(a,t),a):a?.set(t,e),P=(a,t,e)=>(v(a,t)||$(a,t,e()),M(a,t)),B=(a,t,e,s=$)=>(b(t,((t,s)=>e(a,s,t))),((a,t)=>{((a,t)=>{a?.forEach(t)})(a,((a,e)=>t(e)))})(a,(e=>((a,t)=>!p(((a,t)=>f(a,(a=>a[t])))(a,t)))(t,e)?0:s(a,e))),a),W=a=>new Set(Array.isArray(a)||p(a)?a:[a]),j=(a,t)=>a?.add(t),x="_",k="_id",q=a=>`"${a.replace(/"/g,'""')}"`,H="FROM pragma_table_",J="WHERE",U=(a,t,e)=>{const n=I();return[async()=>B(n,O(await T(c(await a("SELECT name "+H+"list WHERE schema='main'AND type='table'AND name IN("+Y(t)+")",t),(async({name:t})=>[t,O(c(await a("SELECT name,type "+H+"info(?)",[t]),(({name:a,type:t})=>[a,t])))])))),((a,t,e)=>$(n,t,B(P(n,t,I),e,((a,t,e)=>{e!=M(a,t)&&$(a,t,e)}),((a,t)=>$(a,t))))),((a,t)=>$(n,t))),async(t,e)=>((a,t)=>!p(M(M(n,a),t)))(t,e)?O(y(c(await a("SELECT*FROM"+q(t)),(a=>{return[a[e],(t={...a},s=e,delete t[s],t)];var t,s})),(([a,t])=>!p(a)&&!D(t)))):{},async(t,e,i,r,w,d=!1)=>{const E=W();b(i??{},(a=>c(R(a??{}),(a=>j(E,a)))));const f=h(E);if(!d&&w&&l(f)&&v(n,t))return await a("DROP TABLE"+q(t)),void $(n,t);if(l(f)||v(n,t)){const s=M(n,t),i=W(_(s));await T([...c(f,(async e=>{A(i,e)||(await a(`ALTER TABLE${q(t)}ADD${q(e)}`),$(s,e,""))})),...!d&&r?c(h(i),(async n=>{n!=e&&(await a(`ALTER TABLE${q(t)}DROP${q(n)}`),$(s,n))})):[]])}else await a(`CREATE TABLE${q(t)}(${q(e)} PRIMARY KEY ON CONFLICT REPLACE${o(c(f,(a=>s+q(a))))});`),$(n,t,I([[e,""],...c(f,(a=>[a,""]))]));if(d)p(i)?await a("DELETE FROM"+q(t)+"WHERE 1"):await T(b(i,(async(s,n)=>{p(s)?await a("DELETE FROM"+q(t)+J+q(e)+"=?",[n]):l(f)||await V(a,t,e,R(s),[n,...C(s)])})));else if(l(f))v(n,t)&&await a("DELETE FROM"+q(t)+"WHERE 1");else{const s=y(_(M(n,t)),(a=>a!=e)),o=[],r=[];b(i??{},((a,t)=>{u(o,t,...c(s,(t=>a?.[t]))),u(r,t)})),await V(a,t,e,s,o),await a("DELETE FROM"+q(t)+J+q(e)+"NOT IN("+Y(r)+")",r)}},async t=>{let s;await a("BEGIN");try{s=await t()}catch(a){e?.(a)}return await a("END"),s}]},V=async(a,t,e,n,l)=>await a("INSERT INTO"+q(t)+"("+q(e)+o(c(n,(a=>s+q(a))))+")VALUES"+i(`,(?${i(",?",r(n))})`,r(l)/(r(n)+1)).substring(1)+"ON CONFLICT("+q(e)+")DO UPDATE SET"+o(c(n,(a=>q(a)+"=excluded."+q(a))),s),l),Y=a=>o(c(a,(()=>"?")),s),z=JSON.parse,G=I(),K=I(),Q=(a,t,e,s,n,i,o=[])=>{let c,r,l,y=0,w=0;P(G,o,(()=>0)),P(K,o,(()=>[]));const d=async a=>(2!=y&&(y=1,await E.schedule((async()=>{await a(),y=0}))),E),E={load:async(e,s)=>await d((async()=>{try{a.setContent(await t())}catch{a.setContent([e,s])}})),startAutoLoad:async(e={},n={})=>(E.stopAutoLoad(),await E.load(e,n),w=1,l=s((async(e,s)=>{if(s){const t=s();await d((async()=>a.setTransactionChanges(t)))}else await d((async()=>{try{a.setContent(e?.()??await t())}catch(a){i?.(a)}}))})),E),stopAutoLoad:()=>(w&&(n(l),l=void 0,w=0),E),save:async t=>(1!=y&&(y=2,await E.schedule((async()=>{try{await e(a.getContent,t)}catch(a){i?.(a)}y=0}))),E),startAutoSave:async()=>(await E.stopAutoSave().save(),c=a.addDidFinishTransactionListener(((a,t)=>{const[e,s]=t();D(e)&&D(s)||E.save((()=>[e,s]))})),E),stopAutoSave:()=>(f(c,a.delListener),E),schedule:async(...a)=>(u(M(K,o),...a),await(async()=>{if(!M(G,o)){for($(G,o,1);!p((a=M(K,o),r=a.shift()));)try{await r()}catch(a){i?.(a)}$(G,o,0)}var a})(),E),getStore:()=>a,destroy:()=>E.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return N(E)},X="store",Z=(a,t,e,s,n,[i],o,c)=>{const[r,l,y,w]=U(t,o,n);return Q(a,(async()=>await w((async()=>(await r(),z((await l(i,k))[x]?.[X]??"null"))))),(async a=>await w((async()=>{var t;await r(),await y(i,k,{[x]:{[X]:(t=a()??null,JSON.stringify(t,((a,t)=>E(t,Map)?L.fromEntries([...t]):t)))}},!0,!0)}))),e,s,n,c)},aa=(a,t,e,s,n,[i,o,[c,r,l]],w,u)=>{const[d,E,f,m]=U(t,w,n),v=async(a,t)=>await T(F(o,(async([e,s,n,i],o)=>{const c=a[o];t&&void 0===c||await f(e,s,c,n,i,t)}))),h=async(a,t)=>r?await f(l,k,{[x]:a},!0,!0,t):null;return Q(a,(async()=>await m((async()=>{await d();const a=await(async()=>O(y(await T(F(i,(async([a,t],e)=>[a,await E(e,t)]))),(a=>!D(a[1])))))(),t=await(async()=>c?(await E(l,k))[x]:{})();return D(a)&&p(t)?void 0:[a,t]}))),(async(a,t)=>await m((async()=>{if(await d(),p(t)){const[t,e]=a();await v(t),await h(e)}else{const[a,e]=t();await v(a,!0),await h(e,!0)}}))),e,s,n,u)},ta="json",ea="autoLoadIntervalSeconds",sa="rowIdColumnName",na="tableId",ia="tableName",oa={mode:ta,[ea]:1},ca={load:0,save:0,[ia]:e+"_values"},ra=(a,t,e,s)=>{const n=I();return b(a,((a,i)=>{const o=w(C(S(t,m(a)?{[e]:a}:a)),0,g(t));p(o[0])||s(i,o[0])||$(n,i,o)})),n},la="pragma ",ya="data_version",wa="schema_version",ua=(a,t,s,n,i,o,c,r)=>{let l,y;const[u,d,E,p]=(a=>{const t=(a=>S(oa,m(a)?{storeTableName:a}:a??{}))(a),s=t[ea];if(t.mode==ta){const{storeTableName:a=e}=t;return[1,s,[a],W(a)]}const{tables:{load:n={},save:i={}}={},values:o={}}=t,c=w(C(S(ca,o)),0,g(ca)),r=c[2],l=W(r);return[0,s,[ra(n,{[na]:null,[sa]:k},na,(a=>j(l,a)&&a==r)),ra(i,{[ia]:null,[sa]:k,deleteEmptyColumns:0,deleteEmptyTable:0},ia,((a,t)=>j(l,t)&&t==r)),c],l]})(t);return(u?Z:aa)(a,o?async(a,t)=>(o(a,t),await s(a,t)):s,(a=>[setInterval((async()=>{try{const t=(await s(la+ya))[0][ya],e=(await s(la+wa))[0][wa];t==(l??=t)&&e==(y??=e)||(a(),l=t,y=e)}catch{}}),1e3*d),n((t=>p.has(t)?a():0))]),(([a,t])=>{clearInterval(a),l=y=null,i(t)}),c,E,h(p),r)};a.createSqliteWasmPersister=(a,t,e,s,n,i)=>ua(a,s,(async(a,t=[])=>e.exec(a,{bind:t,rowMode:"object",returnValue:"resultRows"}).map((a=>({...a})))),(a=>t.capi.sqlite3_update_hook(e,((t,e,s,n)=>a(n)),0)),(()=>t.capi.sqlite3_update_hook(e,(()=>0),0)),n,i,e)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterSqliteWasm={});
