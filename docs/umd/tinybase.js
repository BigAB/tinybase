var e,t;e=this,t=function(e,t){"use strict";const s=e=>typeof e,o="",n=s(o),r=s(!0),a=s(0),i=s(s),d="type",l="default",c="utf8",u=(e,t)=>e.includes(t),f=(e,t)=>e.every(((s,o)=>0==o||t(e[o-1],s)<=0)),h=(e,t)=>e.sort(t),g=(e,t)=>e.forEach(t),p=e=>v(e,((e,t)=>e+t),0),L=e=>e.length,w=e=>0==L(e),v=(e,t,s)=>e.reduce(t,s),y=e=>e.slice(1),I=e=>JSON.stringify(e,((e,t)=>C(t,Map)?v([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),S=JSON.parse,R=Math.max,T=Math.min,b=isFinite,C=(e,t)=>e instanceof t,m=e=>null==e,k=(e,t,s)=>m(e)?s?.():t(e),E=e=>e==n||e==r,M=e=>s(e)==i,x=()=>{},A=e=>e.size,P=(e,t)=>e?.has(t)??!1,D=e=>m(e)||0==A(e),J=e=>[...e?.values()??[]],F=e=>e.clear(),O=(e,t)=>e?.forEach(t),j=(e,t)=>e?.delete(t),z=e=>new Map(e),N=(e=z)=>[e(),e()],B=e=>[...e?.keys()??[]],_=(e,t)=>e?.get(t),q=(e,t)=>O(e,((e,s)=>t(s,e))),H=(e,t,s)=>m(s)?(j(e,t),e):e?.set(t,s),W=(e,t,s,o)=>(P(e,t)||(o?.(s),e.set(t,s)),_(e,t)),G=(e,t)=>{const s={},o=t??(e=>e);return O(e,((e,t)=>s[t]=o(e))),s},K=(e,t)=>{const s=z(),o=t??(e=>e);return O(e,((e,t)=>s.set(t,o(e)))),s},Q=e=>new Set(e),U=(e,t)=>e?.add(t),V=(e,t,s)=>{const o=e.hasRow,n=z(),r=z(),a=z(),i=z(),d=z(),l=t=>k(_(d,t),(s=>{O(s,e.delListener),H(d,t)})),c=e=>{H(n,e),H(r,e),H(a,e),H(i,e),l(e)};return[()=>e,()=>B(n),e=>q(r,e),e=>P(r,e),e=>_(n,e),e=>_(r,e),(e,t)=>H(r,e,t),(c,u,f,h,p)=>{const L=z(),w=z();H(n,c,u),P(r,c)||(H(r,c,t()),H(a,c,z()),H(i,c,z()));const v=_(a,c),y=_(i,c),I=t=>{const n=s=>e.getCell(u,t,s),r=_(v,t),a=o(u,t)?s(h(n,t)):void 0;if(r!=a&&H(L,t,[r,a]),!m(p)){const e=_(y,t),s=o(u,t)?p(n,t):void 0;e!=s&&H(w,t,s)}},S=e=>{f((()=>{O(L,(([,e],t)=>H(v,t,e))),O(w,((e,t)=>H(y,t,e)))}),L,w,v,y,e),F(L),F(w)};q(v,I),e.hasTable(u)&&g(e.getRowIds(u),(e=>{P(v,e)||I(e)})),S(!0),l(c),H(d,c,Q([e.addRowListener(u,null,((e,t,s)=>I(s))),e.addTableListener(u,(()=>S()))]))},c,()=>q(d,c)]},X=(e,t)=>s(e)==n?t=>t(e):e??(()=>t??o),Y=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Z=(e,t,s)=>L(s)<2?U(w(s)?e:W(e,s[0],Q()),t):Z(W(e,s[0],z()),t,y(s)),$=e=>{const t=(s,o,...n)=>k(s,(s=>w(n)?e(s,o):g([n[0],null],(e=>t(_(s,e),o,...y(n))))));return t},ee=e=>{let t,s=0;const o=[],n=z();return[(r,a,i=[])=>{t??=e();const d=o.pop()??""+s++;return H(n,d,[r,a,i]),Z(a,d,i),d},(e,s=[],...o)=>$(O)(e,(e=>k(_(n,e),(([e])=>e(t,...s,...o)))),...s),e=>k(_(n,e),(([,t,s])=>($(j)(t,e,...s),H(n,e),L(o)<1e3&&o.push(e),s)),(()=>[])),(e,s,o)=>k(_(n,e),(([e,,n])=>{const r=(...a)=>{const i=L(a);i==L(n)?e(t,...a,...o(a)):m(n[i])?g(s[i](...a),(e=>r(...a,e))):r(...a,n[i])};r()}))]},te=Object,se=te.keys,oe=te.isFrozen,ne=te.freeze,re=(e,t)=>!m(((e,t)=>k(e,(e=>e[t])))(e,t)),ae=(e,t)=>delete e[t],ie=(e,t)=>g(te.entries(e),(([e,s])=>t(s,e))),de=Y((e=>{let t,s,o,n=100,r=z(),a=1;const i=Q(),d=z(),[l,c,f]=ee((()=>j)),h=z(),p=z(),v=[],y=[],I=(t,s)=>{a=0,e.transaction((()=>O(_(h,s),((s,o)=>O(s,((s,n)=>O(s,((s,r)=>m(s[t])?e.delCell(o,n,r,!0):e.setCell(o,n,r,s[t]))))))))),a=1},S=e=>{H(h,e),H(p,e),c(d,[e])},R=(e,t)=>g(((e,t)=>e.splice(0,t))(e,t??L(e)),S),T=()=>R(v,L(v)-n),b=e.addCellListener(null,null,null,((e,s,n,i,d,l)=>{if(a){k(t,(()=>{v.push(t),T(),R(y),t=void 0,o=1}));const e=W(r,s,z()),a=W(e,n,z()),c=W(a,i,[void 0,void 0],(e=>e[0]=l));c[1]=d,c[0]===c[1]&&D(H(a,i))&&D(H(e,n))&&D(H(r,s))&&(t=v.pop(),o=1),x()}})),C=(e="")=>(m(t)&&(t=""+s++,H(h,t,r),J(t,e),r=z(),o=1),t),E=()=>{w(v)||(y.unshift(C()),I(0,t),t=v.pop(),o=1)},M=()=>{w(y)||(v.push(t),t=y.shift(),I(1,t),o=1)},x=()=>{o&&(c(i),o=0)},A=e=>{const t=C(e);return x(),t},J=(e,t)=>(F(e)&&_(p,e)!==t&&(H(p,e,t),c(d,[e])),j),F=e=>P(h,e),j={setSize:e=>(n=e,T(),j),addCheckpoint:A,setCheckpoint:J,getStore:()=>e,getCheckpointIds:()=>[[...v],t,[...y]],forEachCheckpoint:e=>q(p,e),hasCheckpoint:F,getCheckpoint:e=>_(p,e),goBackward:()=>(E(),x(),j),goForward:()=>(M(),x(),j),goTo:e=>{const s=u(v,e)?E:u(y,e)?M:null;for(;!m(s)&&e!=t;)s();return x(),j},addCheckpointIdsListener:e=>l(e,i),addCheckpointListener:(e,t)=>l(t,d,[e]),delListener:e=>(f(e),j),clear:()=>(R(v),R(y),m(t)||S(t),t=void 0,s=0,A(),j),destroy:()=>{e.delListener(b)},getListenerStats:()=>({})};return ne(j.clear())})),le=(e,t)=>e<t?-1:1,ce=Y((e=>{const t=z(),s=z(),[n,r,a,i,d,l,c,u,g,p]=V(e,z,(e=>m(e)?o:e+o)),[L,w,v]=ee((()=>I)),y=(t,s,o)=>{const n=d(t);O(o,((t,o)=>s(o,(s=>O(t,(t=>s(t,(s=>e.forEachCell(n,t,s)))))))))},I={setIndexDefinition:(e,o,n,r,a,i=le)=>{const d=m(a)?void 0:([e],[t])=>a(e,t);return u(e,o,((o,n,a,u,g,p)=>{let L=0;const v=Q(),y=Q(),I=l(e);if(O(n,(([e,t],s)=>{m(e)||(U(v,e),k(_(I,e),(t=>{j(t,s),D(t)&&(H(I,e),L=1)}))),m(t)||(U(v,t),P(I,t)||(H(I,t,Q()),L=1),U(_(I,t),s),m(r)||U(y,t))})),o(),D(g)||(p?q(I,(e=>U(y,e))):q(a,(e=>k(_(u,e),(e=>U(y,e))))),O(y,(e=>{const t=(t,s)=>i(_(g,t),_(g,s),e),s=[..._(I,e)];f(s,t)||(H(I,e,Q(h(s,t))),U(v,e))}))),(L||p)&&!m(d)){const t=[...I];f(t,d)||(c(e,z(h(t,d))),L=1)}L&&w(t,[e]),O(v,(t=>w(s,[e,t])))}),X(n),k(r,X)),I},delIndexDefinition:e=>(g(e),I),getStore:n,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>y(t,e,s))))),forEachSlice:(e,t)=>y(e,t,l(e)),hasIndex:i,hasSlice:(e,t)=>P(l(e),t),getTableId:d,getSliceIds:e=>B(l(e)),getSliceRowIds:(e,t)=>J(_(l(e),t)),addSliceIdsListener:(e,s)=>L(s,t,[e]),addSliceRowIdsListener:(e,t,o)=>L(o,s,[e,t]),delListener:e=>(v(e),I),destroy:p,getListenerStats:()=>({})};return ne(I)})),ue=z([["avg",[(e,t)=>p(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,o)=>e+(t-s)/o]],["max",[e=>R(...e),(e,t)=>R(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:R(t,e)]],["min",[e=>T(...e),(e,t)=>T(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:T(t,e)]],["sum",[e=>p(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),fe=Y((e=>{const t=z(),[s,n,r,a,i,d,l,c,u,f]=V(e,x,(e=>isNaN(e)||m(e)||!0===e||!1===e||e===o?void 0:1*e)),[h,g,p]=ee((()=>L)),L={setMetricDefinition:(e,s,o,n,r,a,i)=>{const u=M(o)?[o,r,a,i]:_(ue,o)??_(ue,"sum");return c(e,s,((s,o,n,r,a,i)=>{let c=d(e),f=A(r);const[h,p,L,w]=u;i=i||m(c),O(o,(([e,t])=>{i||(c=m(e)?p?.(c,t,f++):m(t)?L?.(c,e,f--):w?.(c,t,e,f)),i=i||m(c)})),s(),D(r)?c=void 0:i&&(c=h(J(r),A(r))),b(c)||(c=void 0);const v=d(e);c!=v&&(l(e,c),g(t,[e],c,v))}),X(n,1)),L},delMetricDefinition:e=>(u(e),L),getStore:s,getMetricIds:n,forEachMetric:r,hasMetric:a,getTableId:i,getMetric:d,addMetricListener:(e,s)=>h(s,t,[e]),delListener:e=>(p(e),L),destroy:f,getListenerStats:()=>({})};return ne(L)})),he=(e,t,s,o,n)=>{let r,a=0;const i={load:async s=>{if(2!=a){a=1;const o=await t();m(o)||""==o?e.setTables(s):e.setJson(o),a=0}return i},startAutoLoad:async e=>(i.stopAutoLoad(),await i.load(e),o(i.load),i),stopAutoLoad:()=>(n(),i),save:async()=>(1!=a&&(a=2,await s(e.getJson()),a=0),i),startAutoSave:async()=>(await i.stopAutoSave().save(),r=e.addTablesListener((()=>i.save())),i),stopAutoSave:()=>(k(r,e.delListener),i),getStore:()=>e,destroy:()=>i.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ne(i)},ge="storage",pe=globalThis.window,Le=(e,t,s)=>{let o;return he(e,(async()=>s.getItem(t)),(async e=>s.setItem(t,e)),(e=>{o=o=>{o.storageArea===s&&o.key===t&&e()},pe.addEventListener(ge,o)}),(()=>{pe.removeEventListener(ge,o),o=void 0}))},we=e=>e.headers.get("ETag"),ve=Y((e=>{const t=z(),s=z(),n=z(),r=z(),[a,i,d,l,c,u,f,h,g,p]=V(e,(()=>[z(),z(),z(),z()]),(e=>m(e)?void 0:e+o)),[L,w,v]=ee((()=>R)),y=(e,t,s)=>k(u(e),(([o,,n])=>{if(!P(n,t)){const r=Q();if(c(e)!=S(e))U(r,t);else{let e=t;for(;!m(e)&&!P(r,e);)U(r,e),e=_(o,e)}if(s)return r;H(n,t,r)}return _(n,t)})),I=(e,t)=>k(u(e),(([,,e])=>H(e,t))),S=e=>_(t,e),R={setRelationshipDefinition:(e,o,a,i)=>(H(t,e,a),h(e,o,((t,o)=>{const a=Q(),i=Q(),d=Q(),[l,c]=u(e);O(o,(([t,s],o)=>{m(t)||(U(i,t),k(_(c,t),(e=>{j(e,o),D(e)&&H(c,t)}))),m(s)||(U(i,s),P(c,s)||H(c,s,Q()),U(_(c,s),o)),U(a,o),H(l,o,s),q(_(r,e),(t=>{P(y(e,t),o)&&U(d,t)}))})),t(),O(a,(t=>w(s,[e,t]))),O(i,(t=>w(n,[e,t]))),O(d,(t=>{I(e,t),w(r,[e,t])}))}),X(i)),R),delRelationshipDefinition:e=>(H(t,e),g(e),R),getStore:a,getRelationshipIds:i,forEachRelationship:t=>d((s=>t(s,(t=>e.forEachRow(c(s),t))))),hasRelationship:l,getLocalTableId:c,getRemoteTableId:S,getRemoteRowId:(e,t)=>_(u(e)?.[0],t),getLocalRowIds:(e,t)=>J(_(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>m(u(e))?[t]:J(y(e,t,!0)),addRemoteRowIdListener:(e,t,o)=>L(o,s,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,n,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(y(e,t),L(s,r,[e,t])),delListener:e=>(I(...v(e)),R),destroy:p,getListenerStats:()=>({})};return ne(R)})),ye=(e,t,s,o=H)=>{const n=(r=B(e),a=e=>!re(t,e),r.filter(a));var r,a;return g(se(t),(o=>s(e,o,t[o]))),g(n,(t=>o(e,t))),e},Ie=e=>{const t=s(e);return E(t)||t==a&&b(e)?t:void 0},Se=(e,t)=>!(m(e)||!(e=>C(e,te)&&e.constructor==te)(e)||oe(e)||(ie(e,((s,o)=>{t(s,o)||ae(e,o)})),(e=>w(se(e)))(e))),Re=(e,t,s)=>H(e,t,_(e,t)==-s?void 0:s);e.createCheckpoints=de,e.createCustomPersister=he,e.createFilePersister=(e,s)=>{let o;return he(e,(async()=>{try{return await t.promises.readFile(s,c)}catch{}}),(async e=>{try{await t.promises.writeFile(s,e,c)}catch{}}),(e=>{o=t.watch(s,e)}),(()=>{o?.close(),o=void 0}))},e.createIndexes=ce,e.createLocalPersister=(e,t)=>Le(e,t,localStorage),e.createMetrics=fe,e.createRelationships=ve,e.createRemotePersister=(e,t,s,o)=>{let n,r;return he(e,(async()=>{const e=await fetch(t);return r=we(e),e.text()}),(async e=>await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:e})),(e=>{n=setInterval((async()=>{const s=await fetch(t,{method:"HEAD"}),o=we(s);m(r)||m(o)||o==r||(r=o,e())}),1e3*o)}),(()=>{k(n,clearInterval),n=void 0}))},e.createSessionPersister=(e,t)=>Le(e,t,sessionStorage),e.createStore=()=>{let e,t=0,s=0;const o=z(),n=z(),r=z(),i=z(),c=z(),f=z(),h=z(),p=N(Q),L=N(Q),w=N(),v=N(),y=N(),R=N(),T=N(),[b,C,x,A]=ee((()=>Ae)),J=(t,s)=>(!e||P(c,s))&&Se(t,(e=>j(s,e))),j=(e,t,s)=>Se(s?t:V(t,e),((s,o)=>k(U(e,o,s),(e=>(t[o]=e,!0)),(()=>!1)))),U=(t,s,o)=>e?k(_(_(c,t),s),(e=>Ie(o)!=e.type?e.default:o)):m(Ie(o))?void 0:o,V=(e,t)=>(k(_(f,t),(t=>ie(t,((t,s)=>{re(e,s)||(e[s]=t)})))),e),X=e=>ye(c,e,((e,t,s)=>{const o={};ye(W(c,t,z()),s,((e,t,s)=>{H(e,t,s),k(s.default,(e=>o[t]=e))})),H(f,t,o)}),((e,t)=>{H(c,t),H(f,t)})),Y=e=>ye(h,e,((e,t,s)=>Z(t,s)),((e,t)=>ce(t))),Z=(e,t)=>ye(W(h,e,z(),(()=>he(e,1))),t,((t,s,o)=>$(e,t,s,o)),((t,s)=>ue(e,t,s))),$=(e,t,s,o,n)=>ye(W(t,s,z(),(()=>ge(e,s,1))),o,((t,o,n)=>te(e,s,t,o,n)),((o,r)=>fe(e,t,s,o,r,n))),te=(e,t,s,o,n)=>{P(s,o)||pe(e,t,o,1);const r=_(s,o);n!==r&&(Le(e,t,o,r),H(s,o,n))},se=(e,t,s)=>xe((()=>$(e,le(e),t,s))),oe=(e,t,s,o,n)=>k(_(t,s),(t=>te(e,s,t,o,n)),(()=>$(e,t,s,V({[o]:n},e)))),de=e=>{const s=""+t++;return P(e,s)?de(e):s},le=e=>_(h,e)??Z(e,{}),ce=e=>Z(e,{}),ue=(e,t,s)=>$(e,t,s,{},!0),fe=(e,t,s,o,n,r)=>{const a=_(f,e)?.[n];if(!m(a)&&!r)return te(e,s,o,n,a);const i=t=>{Le(e,s,t,_(o,t)),pe(e,s,t,-1),H(o,t)};m(a)?i(n):q(o,i),D(o)&&(ge(e,s,-1),D(H(t,s))&&(he(e,-1),H(h,e)))},he=(e,t)=>Re(o,e,t),ge=(e,t,s)=>Re(W(n,e,z()),t,s),pe=(e,t,s,o)=>Re(W(W(r,e,z()),t,z()),s,o),Le=(e,t,s,o)=>W(W(W(i,e,z()),t,z()),s,o),we=(e,t,s)=>{const o=_(_(i,e),t),n=ke(e,t,s);return P(o,s)?[!0,_(o,s),n]:[!1,n,n]},ve=e=>{const t=D(R[e])&&D(v[e])&&D(L[e]),s=D(T[e])&&D(y[e])&&D(w[e])&&D(p[e]);if(t&&s)return;const a=e?[K(o),K(n,K),K(r,(e=>K(e,K))),K(i,(e=>K(e,K)))]:[o,n,r,i];if(t||(O(a[2],((t,s)=>O(t,((t,o)=>{D(t)||C(R[e],[s,o])})))),O(a[1],((t,s)=>{D(t)||C(v[e],[s])})),D(a[0])||C(L[e])),!s){let t;O(a[3],((s,o)=>{let n;O(s,((s,r)=>{let a;O(s,((s,i)=>{const d=ke(o,r,i);d!==s&&(C(T[e],[o,r,i],d,s,we),t=n=a=1)})),a&&C(y[e],[o,r],we)})),n&&C(w[e],[o],we)})),t&&C(p[e],[],we)}},Te=()=>G(h,(e=>G(e,G))),be=()=>B(h),Ce=e=>B(_(h,e)),me=(e,t)=>B(_(_(h,e),t)),ke=(e,t,s)=>_(_(_(h,e),t),s),Ee=e=>((e=>Se(e,J))(e)&&xe((()=>Y(e))),Ae),Me=()=>(xe((()=>Y({}))),Ae),xe=e=>{if(-1==s)return;s++;const t=e();return s--,0==s&&(s=1,ve(1),s=-1,ve(0),s=0,g([i,o,n,r],F)),t},Ae={getTables:Te,getTableIds:be,getTable:e=>G(_(h,e),G),getRowIds:Ce,getRow:(e,t)=>G(_(_(h,e),t)),getCellIds:me,getCell:ke,hasTables:()=>!D(h),hasTable:e=>P(h,e),hasRow:(e,t)=>P(_(h,e),t),hasCell:(e,t,s)=>P(_(_(h,e),t),s),getJson:()=>I(h),getSchemaJson:()=>I(c),setTables:Ee,setTable:(e,t)=>(J(t,e)&&xe((()=>Z(e,t))),Ae),setRow:(e,t,s)=>(j(e,s)&&se(e,t,s),Ae),addRow:(e,t)=>{let s;return j(e,t)&&(s=de(_(h,e)),se(e,s,t)),s},setPartialRow:(e,t,s)=>(j(e,s,1)&&xe((()=>{const o=le(e);ie(s,((s,n)=>oe(e,o,t,n,s)))})),Ae),setCell:(e,t,s,o)=>(k(U(e,s,M(o)?o(ke(e,t,s)):o),(o=>xe((()=>oe(e,le(e),t,s,o))))),Ae),setJson:e=>{try{"{}"===e?Me():Ee(S(e))}catch{}return Ae},setSchema:t=>{if((e=(e=>Se(e,(e=>Se(e,(e=>{if(!Se(e,((e,t)=>u([d,l],t))))return!1;const t=e.type;return!(!E(t)&&t!=a||(Ie(e.default)!=t&&ae(e,l),0))})))))(t))&&(X(t),!D(h))){const e=Te();Me(),Ee(e)}return Ae},delTables:Me,delTable:e=>(P(h,e)&&xe((()=>ce(e))),Ae),delRow:(e,t)=>(k(_(h,e),(s=>{P(s,t)&&xe((()=>ue(e,s,t)))})),Ae),delCell:(e,t,s,o)=>(k(_(h,e),(n=>k(_(n,t),(r=>{P(r,s)&&xe((()=>fe(e,n,t,r,s,o)))})))),Ae),delSchema:()=>(X({}),e=!1,Ae),transaction:xe,forEachTable:e=>O(h,((t,s)=>e(s,(e=>O(t,((t,s)=>e(s,(e=>q(t,e))))))))),forEachRow:(e,t)=>O(_(h,e),((e,s)=>t(s,(t=>q(e,t))))),forEachCell:(e,t,s)=>q(_(_(h,e),t),s),addTablesListener:(e,t)=>b(e,p[t?1:0]),addTableIdsListener:(e,t)=>b(e,L[t?1:0]),addTableListener:(e,t,s)=>b(t,w[s?1:0],[e]),addRowIdsListener:(e,t,s)=>b(t,v[s?1:0],[e]),addRowListener:(e,t,s,o)=>b(s,y[o?1:0],[e,t]),addCellIdsListener:(e,t,s,o)=>b(s,R[o?1:0],[e,t]),addCellListener:(e,t,s,o,n)=>b(o,T[n?1:0],[e,t,s]),callListener:e=>(A(e,[be,Ce,me],(e=>m(e[2])?[]:[,,].fill(ke(...e)))),Ae),delListener:e=>(x(e),Ae),getListenerStats:()=>({})};return ne(Ae)},e.defaultSorter=le,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={},e.fs);
