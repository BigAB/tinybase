var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),o=t(!0),r=t(0),a=t(t),i="type",l="default",c="Listener",d="Result",u="add",h="Ids",f="Table",g=f+"s",L=f+h,S="Row",w=S+h,R="Sorted"+S+h,v="Cell",T=v+h,p="Value",I=p+"s",C=p+h,b=e=>s+e,y=(e,t)=>e.includes(t),m=(e,t)=>e.every(t),V=(e,t)=>D(e)===D(t)&&m(e,((e,s)=>t[s]===e)),E=(e,t)=>m(e,((s,n)=>0==n||t(e[n-1],s)<=0)),k=(e,t)=>e.sort(t),M=(e,t)=>e.forEach(t),J=(e,t)=>e.map(t),x=e=>F(e,((e,t)=>e+t),0),D=e=>e.length,A=e=>0==D(e),F=(e,t,s)=>e.reduce(t,s),Q=(e,t,s)=>e.slice(t,s),z=(e,...t)=>e.push(...t),N=e=>e.pop(),j=e=>e.shift(),O=e=>JSON.stringify(e,((e,t)=>q(t,Map)?F([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),P=JSON.parse,B=Math.max,W=Math.min,$=isFinite,q=(e,t)=>e instanceof t,G=e=>null==e,H=(e,t,s)=>G(e)?s?.():t(e),K=e=>e==n||e==o,U=e=>t(e)==a,X=e=>Array.isArray(e),Y=()=>{},Z=e=>e.size,_=(e,t)=>e?.has(t)??!1,ee=e=>G(e)||0==Z(e),te=e=>[...e?.values()??[]],se=e=>e.clear(),ne=(e,t)=>e?.forEach(t),oe=(e,t)=>e?.delete(t),re=e=>new Map(e),ae=e=>[...e?.keys()??[]],ie=(e,t)=>e?.get(t),le=(e,t)=>ne(e,((e,s)=>t(s,e))),ce=(e,t,s)=>G(s)?(oe(e,t),e):e?.set(t,s),de=(e,t,s)=>(_(e,t)||ce(e,t,s()),ie(e,t)),ue=(e,t,s)=>{const n={},o=t??(e=>e);return ne(e,((e,t)=>H(o(e),(e=>s?.(e)?0:n[t]=e)))),n},he=(e,t)=>{const s=re(),n=t??(e=>e);return ne(e,((e,t)=>s.set(t,n(e)))),s},fe=e=>he(e,he),ge=(e,t,s,n,o=0)=>H((s?de:ie)(e,t[o],o>D(t)-2?s:re),(r=>{if(o>D(t)-2)return n?.(r)&&ce(e,t[o]),r;const a=ge(r,t,s,n,o+1);return ee(r)&&ce(e,t[o]),a})),Le=e=>{const s=t(e);return K(s)||s==r&&$(e)?s:void 0},Se=(e,t,s,n,o)=>G(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),we=(e,t,s)=>G(s)?e.delValue(t):e.setValue(t,s),Re=e=>new Set(X(e)||G(e)?e:[e]),ve=(e,t)=>e?.add(t),Te=(e,t,s)=>{const n=e.hasRow,o=re(),r=re(),a=re(),i=re(),l=re(),c=(t,s,...n)=>{const o=de(l,t,Re);return M(n,(t=>ve(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>H(ie(l,t),(n=>{M(A(s)?te(n):s,(t=>{e.delListener(t),oe(n,t)})),ee(n)&&ce(l,t)})),u=(e,s)=>{ce(o,e,s),_(r,e)||(ce(r,e,t()),ce(a,e,re()),ce(i,e,re()))},h=e=>{ce(o,e),ce(r,e),ce(a,e),ce(i,e),d(e)};return[()=>e,()=>ae(o),e=>le(r,e),e=>_(r,e),e=>ie(o,e),e=>ie(r,e),(e,t)=>ce(r,e,t),u,(t,o,r,l,h)=>{u(t,o);const f=re(),g=re(),L=ie(a,t),S=ie(i,t),w=t=>{const r=s=>e.getCell(o,t,s),a=ie(L,t),i=n(o,t)?s(l(r,t)):void 0;if(a===i||X(a)&&X(i)&&V(a,i)||ce(f,t,[a,i]),!G(h)){const e=ie(S,t),s=n(o,t)?h(r,t):void 0;e!=s&&ce(g,t,s)}},R=e=>{r((()=>{ne(f,(([,e],t)=>ce(L,t,e))),ne(g,((e,t)=>ce(S,t,e)))}),f,g,L,S,e),se(f),se(g)};le(L,w),e.hasTable(o)&&M(e.getRowIds(o),(e=>{_(L,e)||w(e)})),R(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>w(s))),e.addTableListener(o,(()=>R())))},h,()=>le(l,h),c,d]},pe=(e,o)=>t(e)==n?t=>t(e):e??(()=>o??s),Ie=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Ce=/^\d+$/,be=()=>{const e=[];let t=0;return[n=>(n?j(e):null)??s+t++,t=>{Ce.test(t)&&D(e)<1e3&&z(e,t)}]},ye=e=>{let t;const[n,o]=be(),r=re();return[(o,a,i,l=[],c=(()=>[]))=>{t??=e();const d=n(1);return ce(r,d,[o,a,i,l,c]),ve(ge(a,i??[s],Re),d),d},(e,n,...o)=>M(((e,t=[s])=>{const n=[],o=(e,s)=>s==D(t)?z(n,e):null===t[s]?ne(e,(e=>o(e,s+1))):M([t[s],null],(t=>o(ie(e,t),s+1)));return o(e,0),n})(e,n),(e=>ne(e,(e=>ie(r,e)[0](t,...n??[],...o))))),e=>H(ie(r,e),(([,t,n])=>(ge(t,n??[s],void 0,(t=>(oe(t,e),ee(t)?1:0))),ce(r,e),o(e),n))),e=>H(ie(r,e),(([e,,s=[],n,o])=>{const r=(...a)=>{const i=D(a);i==D(s)?e(t,...a,...o(a)):G(s[i])?M(n[i]?.(...a)??[],(e=>r(...a,e))):r(...a,s[i])};r()}))]},me=Object,Ve=me.keys,Ee=me.isFrozen,ke=me.freeze,Me=e=>q(e,me)&&e.constructor==me,Je=(e,t)=>!G(((e,t)=>H(e,(e=>e[t])))(e,t)),xe=(e,t)=>delete e[t],De=(e,t)=>J(me.entries(e),(([e,s])=>t(s,e))),Ae=e=>Me(e)&&A(Ve(e)),Fe=Ie((e=>{let t,n,o,r=100,a=re(),i=re(),l=1;const c=re(),d=re(),[u,h,f]=ye((()=>O)),g=re(),L=re(),S=[],w=[],R=(t,s)=>{l=0,e.transaction((()=>{const[n,o]=ie(g,s);ne(n,((s,n)=>ne(s,((s,o)=>ne(s,((s,r)=>Se(e,n,o,r,s[t]))))))),ne(o,((s,n)=>we(e,n,s[t])))})),l=1},v=e=>{ce(g,e),ce(L,e),h(d,[e])},T=(e,t)=>M(((e,t)=>e.splice(0,t))(e,t??D(e)),v),p=()=>T(S,D(S)-r),I=()=>H(t,(()=>{z(S,t),p(),T(w),t=void 0,o=1})),C=()=>{t=N(S),o=1},b=e.addCellListener(null,null,null,((e,t,s,n,o,r)=>{if(l){I();const e=de(a,t,re),i=de(e,s,re),l=de(i,n,(()=>[r,void 0]));l[1]=o,l[0]===o&&ee(ce(i,n))&&ee(ce(e,s))&&ee(ce(a,t))&&C(),J()}})),m=e.addValueListener(null,((e,t,s,n)=>{if(l){I();const e=de(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ee(ce(i,t))&&C(),J()}})),V=(e="")=>(G(t)&&(t=s+n++,ce(g,t,[a,i]),F(t,e),a=re(),i=re(),o=1),t),E=()=>{A(S)||(((e,...t)=>{e.unshift(...t)})(w,V()),R(0,t),t=N(S),o=1)},k=()=>{A(w)||(z(S,t),t=j(w),R(1,t),o=1)},J=()=>{o&&(h(c),o=0)},x=e=>{const t=V(e);return J(),t},F=(e,t)=>(Q(e)&&ie(L,e)!==t&&(ce(L,e,t),h(d,[e])),O),Q=e=>_(g,e),O={setSize:e=>(r=e,p(),O),addCheckpoint:x,setCheckpoint:F,getStore:()=>e,getCheckpointIds:()=>[[...S],t,[...w]],forEachCheckpoint:e=>le(L,e),hasCheckpoint:Q,getCheckpoint:e=>ie(L,e),goBackward:()=>(E(),J(),O),goForward:()=>(k(),J(),O),goTo:e=>{const s=y(S,e)?E:y(w,e)?k:null;for(;!G(s)&&e!=t;)s();return J(),O},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(f(e),O),clear:()=>(T(S),T(w),G(t)||v(t),t=void 0,n=0,x(),O),destroy:()=>{e.delListener(b),e.delListener(m)},getListenerStats:()=>({})};return ke(O.clear())})),Qe=(e,t)=>e<t?-1:1,ze=Ie((e=>{const t=re(),n=re(),[o,r,a,i,l,c,d,,u,h,f]=Te(e,re,(e=>G(e)?s:X(e)?J(e,b):b(e))),[g,L,S]=ye((()=>R)),w=(t,s,n)=>{const o=l(t);ne(n,((t,n)=>s(n,(s=>ne(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},R={setIndexDefinition:(e,s,o,r,a,i=Qe)=>{const l=G(a)?void 0:([e],[t])=>a(e,t);return u(e,s,((s,o,a,u,h,f)=>{let g=0;const S=Re(),w=Re(),R=c(e);if(ne(o,(([e,t],s)=>{const n=Re(e),o=Re(t);ne(n,(e=>oe(o,e)?oe(n,e):0)),ne(n,(e=>{ve(S,e),H(ie(R,e),(t=>{oe(t,s),ee(t)&&(ce(R,e),g=1)}))})),ne(o,(e=>{ve(S,e),_(R,e)||(ce(R,e,Re()),g=1),ve(ie(R,e),s),G(r)||ve(w,e)}))})),s(),ee(h)||(f?le(R,(e=>ve(w,e))):le(a,(e=>H(ie(u,e),(e=>ve(w,e))))),ne(w,(e=>{const t=(t,s)=>i(ie(h,t),ie(h,s),e),s=[...ie(R,e)];E(s,t)||(ce(R,e,Re(k(s,t))),ve(S,e))}))),(g||f)&&!G(l)){const t=[...R];E(t,l)||(d(e,re(k(t,l))),g=1)}g&&L(t,[e]),ne(S,(t=>L(n,[e,t])))}),pe(o),H(r,pe)),R},delIndexDefinition:e=>(h(e),R),getStore:o,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>w(t,e,s))))),forEachSlice:(e,t)=>w(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>_(c(e),t),getTableId:l,getSliceIds:e=>ae(c(e)),getSliceRowIds:(e,t)=>te(ie(c(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>g(s,n,[e,t]),delListener:e=>(S(e),R),destroy:f,getListenerStats:()=>({})};return ke(R)})),Ne=re([["avg",[(e,t)=>x(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>B(...e),(e,t)=>B(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:B(t,e)]],["min",[e=>W(...e),(e,t)=>W(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:W(t,e)]],["sum",[e=>x(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),je=(e,t,s,n,o,r=!1)=>{if(ee(s))return;const[a,i,l,c]=o;return r||=G(e),ne(n,(([s,n])=>{r||(e=G(s)?i?.(e,n,t++):G(n)?l?.(e,s,t--):c?.(e,n,s,t),r||=G(e))})),r?a(te(s),Z(s)):e},Oe=Ie((e=>{const t=re(),[n,o,r,a,i,l,c,,d,u,h]=Te(e,Y,(e=>isNaN(e)||G(e)||!0===e||!1===e||e===s?void 0:1*e)),[f,g,L]=ye((()=>S)),S={setMetricDefinition:(e,s,n,o,r,a,i)=>{const u=U(n)?[n,r,a,i]:ie(Ne,n)??ie(Ne,"sum");return d(e,s,((s,n,o,r,a,i)=>{const d=l(e),h=Z(r);i||=G(d),s();let f=je(d,h,r,n,u,i);$(f)||(f=void 0),f!=d&&(c(e,f),g(t,[e],f,d))}),pe(o,1)),S},delMetricDefinition:e=>(u(e),S),getStore:n,getMetricIds:o,forEachMetric:r,hasMetric:a,getTableId:i,getMetric:l,addMetricListener:(e,s)=>f(s,t,[e]),delListener:e=>(L(e),S),destroy:h,getListenerStats:()=>({})};return ke(S)})),Pe=Ie((e=>{const t=e.createStore,[n,o,r,a,i,,,l,,h,g,L,p]=Te(e,(()=>!0),Y),I=t(),C=t(),b=re(),y=(e,t,...s)=>M(s,(s=>ve(de(de(b,t,re),e,Re),s))),V=e=>{H(ie(b,e),(e=>{le(e,((e,t)=>ne(t,(t=>e.delListener(t))))),se(e)})),M([C,I],(t=>t.delTable(e)))},E=(e,t,s)=>y(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),k={setQueryDefinition:(t,n,o)=>{l(t,n),V(t);const r=[],a=[[null,[n,null,null,[],re()]]],i=[],c=[],d=[];o({select:(e,t)=>{const n=U(e)?[D(r)+s,e]:[G(t)?e:t,s=>s(e,t)];return z(r,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=G(s)||U(t)?null:t,o=G(n)?t:s,r=[e,[e,n,U(o)?o:e=>e(o),[],re()]];return z(a,r),{as:e=>r[0]=e}},where:(e,t,s)=>z(i,U(e)?e:G(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const r=[e,[e,U(t)?[t,s,n,o]:ie(Ne,t)??[(e,t)=>t]]];return z(c,r),{as:e=>r[0]=e}},having:(e,t)=>z(d,U(e)?e:s=>s(e)===t)});const u=re(r);if(ee(u))return k;const h=re(a);le(h,((e,[,t])=>H(ie(h,t),(({3:t})=>G(e)?0:z(t,e)))));const f=re(c);let g=I;if(ee(f)&&A(d))g=C;else{E(t,g,C);const e=re();le(f,((t,[s,n])=>ve(de(e,s,Re),[t,n])));const s=Re();le(u,(t=>_(e,t)?0:ve(s,t)));const n=re(),o=(s,n,o,r)=>H(s,(([a,i,l,c])=>{le(n,((t,[s])=>{const n=de(a,t,re),i=ie(n,o),l=r?void 0:s;if(i!==l){const s=Re([[i,l]]),r=Z(n);ce(n,o,l),ne(ie(e,t),(([e,t])=>{const o=je(c[e],r,n,s,t);c[e]=G(Le(o))?null:o}))}})),ee(i)||!m(d,(e=>e((e=>c[e]))))?C.delRow(t,l):G(l)?s[2]=C.addRow(t,c):C.setRow(t,l,c)}));y(g,t,g.addRowListener(t,null,((r,a,i,l)=>{const c=[],d=[],u=re(),h=g.hasRow(t,i);let f=!h;ne(s,(e=>{const[s,n,o]=l(t,i,e);z(c,n),z(d,o),f||=s})),le(e,(e=>{const[s,,n]=l(t,i,e);(f||s)&&ce(u,e,[n])})),f&&o(ge(n,c,void 0,(([,e])=>(oe(e,i),ee(e)))),u,i,1),h&&o(ge(n,d,(()=>{const e={};return ne(s,(s=>e[s]=g.getCell(t,i,s))),[re(),Re(),void 0,e]}),(([,e])=>{ve(e,i)})),u,i)})))}E(t,e,g);const S=(s,o,r,a)=>{const l=t=>e.getCell(o,r,t);M(a,(n=>{const[o,,r,a,i]=ie(h,n),c=r?.(l,s),[d,u]=ie(i,s)??[];c!=d&&(G(u)||p(t,u),ce(i,s,G(c)?null:[c,...L(t,1,e.addRowListener(o,c,(()=>S(s,o,c,a))))]))})),(s=>{const o=(t,o)=>e.getCell(...G(o)?[n,s,t]:t===n?[n,s,o]:[ie(h,t)?.[0],ie(ie(h,t)?.[4],s)?.[0],o]);g.transaction((()=>m(i,(e=>e(o)))?le(u,((e,n)=>Se(g,t,s,e,n(o,s)))):g.delRow(t,s)))})(s)},{3:w}=ie(h,null);return g.transaction((()=>L(t,1,e.addRowListener(n,null,((s,o,r)=>{e.hasRow(n,r)?S(r,n,r,w):(g.delRow(t,r),ne(h,(({4:e})=>H(ie(e,r),(([,s])=>{p(t,s),ce(e,r)})))))}))))),k},delQueryDefinition:e=>(V(e),h(e),k),getStore:n,getQueryIds:o,forEachQuery:r,hasQuery:a,getTableId:i,delListener:e=>(C.delListener(e),k),destroy:g,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=C.getListenerStats();return n}};return De({[f]:[1,1],[w]:[0,1],[R]:[0,5],[S]:[1,2],[T]:[0,2],[v]:[1,3]},(([e,t],s)=>{M(e?["get","has","forEach"]:["get"],(e=>k[e+d+s]=(...t)=>C[e+s](...t))),k[u+d+s+c]=(...e)=>C[u+s+c](...Q(e,0,t),((s,...n)=>e[t](k,...n)))})),ke(k)})),Be=Ie((e=>{const t=re(),n=re(),o=re(),r=re(),[a,i,l,c,d,u,,,h,f,g]=Te(e,(()=>[re(),re(),re(),re()]),(e=>G(e)?void 0:e+s)),[L,S,w]=ye((()=>p)),R=(e,t,s)=>H(u(e),(([n,,o])=>{if(!_(o,t)){const r=Re();if(d(e)!=T(e))ve(r,t);else{let e=t;for(;!G(e)&&!_(r,e);)ve(r,e),e=ie(n,e)}if(s)return r;ce(o,t,r)}return ie(o,t)})),v=(e,t)=>H(u(e),(([,,e])=>ce(e,t))),T=e=>ie(t,e),p={setRelationshipDefinition:(e,s,a,i)=>(ce(t,e,a),h(e,s,((t,s)=>{const a=Re(),i=Re(),l=Re(),[c,d]=u(e);ne(s,(([t,s],n)=>{G(t)||(ve(i,t),H(ie(d,t),(e=>{oe(e,n),ee(e)&&ce(d,t)}))),G(s)||(ve(i,s),_(d,s)||ce(d,s,Re()),ve(ie(d,s),n)),ve(a,n),ce(c,n,s),le(ie(r,e),(t=>{_(R(e,t),n)&&ve(l,t)}))})),t(),ne(a,(t=>S(n,[e,t]))),ne(i,(t=>S(o,[e,t]))),ne(l,(t=>{v(e,t),S(r,[e,t])}))}),pe(i)),p),delRelationshipDefinition:e=>(ce(t,e),f(e),p),getStore:a,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:T,getRemoteRowId:(e,t)=>ie(u(e)?.[0],t),getLocalRowIds:(e,t)=>te(ie(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>G(u(e))?[t]:te(R(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>L(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(R(e,t),L(s,r,[e,t])),delListener:e=>(v(...w(e)),p),destroy:g,getListenerStats:()=>({})};return ke(p)})),We=e=>[e,e],$e=()=>[re(),re()],qe=(e,t,s,n=ce)=>(De(t,((t,n)=>s(e,n,t))),le(e,(s=>Je(t,s)?0:n(e,s))),e),Ge=(e,t,s)=>G(e)||!Me(e)||Ae(e)||Ee(e)?(s?.(),!1):(De(e,((s,n)=>{t(s,n)||xe(e,n)})),!Ae(e)),He=(e,t,s)=>ce(e,t,ie(e,t)==-s?void 0:s),Ke=()=>{let e,t,s,n,o=0;const a=re(),d=re(),h=re(),R=re(),m=re(),E=re(),x=re(),D=re(),A=re(),F=re(),N=re(),j=re(),B=re(),W=Re(),$=re(),q=re(),X=re(),Y=re(),Z=$e(),te=$e(),ge=$e(),Te=$e(),pe=$e(),Ie=$e(),Ce=$e(),me=$e(),Ve=$e(),Ee=$e(),Me=$e(),Fe=$e(),ze=$e(),Ne=$e(),je=re(),Oe=$e(),[Pe,Be,Ue,Xe]=ye((()=>rs)),Ye=e=>{if(!Ge(e,((e,t)=>y([i,l],t))))return!1;const t=e[i];return!(!K(t)&&t!=r||(Le(e[l])!=t&&xe(e,l),0))},Ze=(t,s)=>(!e||_(F,s)||Et(s))&&Ge(t,((e,t)=>_e(s,t,e)),(()=>Et(s))),_e=(e,t,s,n)=>Ge(n?s:nt(s,e,t),((n,o)=>H(et(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Et(e,t))),et=(t,s,n,o)=>e?H(ie(ie(F,t),n),(e=>Le(o)!=e[i]?Et(t,s,n,o,e[l]):o),(()=>Et(t,s,n,o))):G(Le(o))?Et(t,s,n,o):o,tt=(e,t)=>Ge(t?e:ot(e),((t,s)=>H(st(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>kt())),st=(e,s)=>t?H(ie(j,e),(t=>Le(s)!=t[i]?kt(e,s,t[l]):s),(()=>kt(e,s))):G(Le(s))?kt(e,s):s,nt=(e,t,s)=>(H(ie(N,t),(([n,o])=>{ne(n,((t,s)=>{Je(e,s)||(e[s]=t)})),ne(o,(n=>{Je(e,n)||Et(t,s,n)}))})),e),ot=e=>(t&&(ne(B,((t,s)=>{Je(e,s)||(e[s]=t)})),ne(W,(t=>{Je(e,t)||kt(t)}))),e),rt=e=>qe(F,e,((e,t,s)=>{const n=re(),o=Re();qe(de(F,t,re),s,((e,t,s)=>{ce(e,t,s),H(s[l],(e=>ce(n,t,e)),(()=>ve(o,t)))})),ce(N,t,[n,o])}),((e,t)=>{ce(F,t),ce(N,t)})),at=e=>qe(j,e,((e,t,s)=>{ce(j,t,s),H(s[l],(e=>ce(B,t,e)),(()=>ve(W,t)))}),((e,t)=>{ce(j,t),ce(B,t),oe(W,t)})),it=e=>Ae(e)?Zt():Ht(e),lt=e=>qe(X,e,((e,t,s)=>ct(t,s)),((e,t)=>Rt(t))),ct=(e,t)=>qe(de(X,e,(()=>(It(e,1),ce($,e,be()),ce(q,e,re()),re()))),t,((t,s,n)=>dt(e,t,s,n)),((t,s)=>vt(e,t,s))),dt=(e,t,s,n,o)=>qe(de(t,s,(()=>(Ct(e,s,1),re()))),n,((t,n,o)=>ut(e,s,t,n,o)),((n,r)=>Tt(e,t,s,n,r,o))),ut=(e,t,s,n,o)=>{_(s,n)||bt(e,t,n,1);const r=ie(s,n);o!==r&&(yt(e,t,n,r,o),ce(s,n,o))},ht=(e,t,s,n,o)=>H(ie(t,s),(t=>ut(e,s,t,n,o)),(()=>dt(e,t,s,nt({[n]:o},e,s)))),ft=e=>Ae(e)?_t():Kt(e),gt=e=>qe(Y,e,((e,t,s)=>Lt(t,s)),((e,t)=>pt(t))),Lt=(e,t)=>{_(Y,e)||mt(e,1);const s=ie(Y,e);t!==s&&(Vt(e,s,t),ce(Y,e,t))},St=(e,t)=>{const[s]=ie($,e),n=s(t);return _(ie(X,e),n)?St(e,t):n},wt=e=>ie(X,e)??ct(e,{}),Rt=e=>ct(e,{}),vt=(e,t,s)=>{const[,n]=ie($,e);n(s),dt(e,t,s,{},!0)},Tt=(e,t,s,n,o,r)=>{const a=ie(ie(N,e)?.[0],o);if(!G(a)&&!r)return ut(e,s,n,o,a);const i=t=>{yt(e,s,t,ie(n,t)),bt(e,s,t,-1),ce(n,t)};G(a)?i(o):le(n,i),ee(n)&&(Ct(e,s,-1),ee(ce(t,s))&&(It(e,-1),ce(X,e),ce($,e),ce(q,e)))},pt=e=>{const t=ie(B,e);if(!G(t))return Lt(e,t);Vt(e,ie(Y,e)),mt(e,-1),ce(Y,e)},It=(e,t)=>He(a,e,t),Ct=(e,t,s)=>He(de(h,e,re),t,s),bt=(e,t,s,n)=>{const o=ie(q,e),r=ie(o,s)??0;(0==r&&1==n||1==r&&-1==n)&&He(de(d,e,re),s,n),ce(o,s,r!=-n?r+n:null),He(de(de(R,e,re),t,re),s,n)},yt=(e,t,s,n,o)=>de(de(de(m,e,re),t,re),s,(()=>[n,0]))[1]=o,mt=(e,t)=>He(E,e,t),Vt=(e,t,s)=>de(x,e,(()=>[t,0]))[1]=s,Et=(e,t,s,n,o)=>(z(de(de(de(D,e,re),t,re),s,(()=>[])),n),o),kt=(e,t,s)=>(z(de(A,e,(()=>[])),t),s),Mt=(e,t,s)=>H(ie(ie(ie(m,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...We(Wt(e,t,s))])),Jt=e=>H(ie(x,e),(([e,t])=>[!0,e,t]),(()=>[!1,...We(Gt(e))])),xt=e=>ee(D)||ee(Ee[e])?0:ne(e?he(D,fe):D,((t,s)=>ne(t,((t,n)=>ne(t,((t,o)=>Be(Ee[e],[s,n,o],t))))))),Dt=e=>ee(A)||ee(Me[e])?0:ne(e?he(A):A,((t,s)=>Be(Me[e],[s],t))),At=(e,t,s)=>{if(!ee(t))return Be(e,s,(()=>ue(t))),1},Ft=e=>{const t=ee(Ie[e]),s=ee(me[e])&&ee(Te[e])&&ee(pe[e])&&t&&ee(te[e]),n=ee(Ve[e])&&ee(Ce[e])&&ee(ge[e])&&ee(Z[e]);if(!s||!n){const o=e?[he(a),fe(d),fe(h),he(R,fe),he(m,fe)]:[a,d,h,R,m];if(!s){ne(o[1],((t,s)=>At(Te[e],t,[s]))),ne(o[3],((t,s)=>ne(t,((t,n)=>At(me[e],t,[s,n])))));const s=Re();ne(o[2],((n,o)=>{At(pe[e],n,[o])&&!t&&(Be(Ie[e],[o,null]),ve(s,o))})),t||ne(o[4],((t,n)=>{if(!_(s,n)){const s=Re();ne(t,(e=>ne(e,(([t,n],o)=>n!==t?ve(s,o):oe(e,o))))),ne(s,(t=>Be(Ie[e],[n,t])))}})),At(te[e],o[0])}if(!n){let t;ne(o[4],((s,n)=>{let o;ne(s,((s,r)=>{let a;ne(s,(([s,i],l)=>{i!==s&&(Be(Ve[e],[n,r,l],i,s,Mt),t=o=a=1)})),a&&Be(Ce[e],[n,r],Mt)})),o&&Be(ge[e],[n],Mt)})),t&&Be(Z[e],void 0,Mt)}}},Qt=e=>{const t=ee(ze[e]),s=ee(Ne[e])&&ee(Fe[e]);if(!t||!s){const n=e?[he(E),he(x)]:[E,x];if(t||At(ze[e],n[0]),!s){let t;ne(n[1],(([s,n],o)=>{n!==s&&(Be(Ne[e],[o],n,s,Jt),t=1)})),t&&Be(Fe[e],void 0,Jt)}}},zt=(e,...t)=>(ss((()=>e(...J(t,b)))),rs),Nt=()=>ue(X,(e=>ue(e,ue))),jt=()=>ae(X),Ot=e=>ae(ie(X,b(e))),Pt=(e,t,s,n=0,o)=>{return J(Q(k((r=ie(X,b(e)),a=(e,s)=>[G(t)?s:ie(e,b(t)),s],J([...r?.entries()??[]],(([e,t])=>a(t,e)))),(([e],[t])=>Qe(e,t)*(s?-1:1))),n,G(o)?o:n+o),(([,e])=>e));var r,a},Bt=(e,t)=>ae(ie(ie(X,b(e)),b(t))),Wt=(e,t,s)=>ie(ie(ie(X,b(e)),b(t)),b(s)),$t=()=>ue(Y),qt=()=>ae(Y),Gt=e=>ie(Y,b(e)),Ht=e=>zt((()=>(e=>Ge(e,Ze,Et))(e)?lt(e):0)),Kt=e=>zt((()=>tt(e)?gt(e):0)),Ut=e=>{try{it(P(e))}catch{}return rs},Xt=t=>zt((()=>{if((e=Ge(t,(e=>Ge(e,Ye))))&&(rt(t),!ee(X))){const e=Nt();Zt(),Ht(e)}})),Yt=e=>zt((()=>{if(t=(e=>Ge(e,Ye))(e)){const s=$t();ts(),_t(),t=!0,at(e),Kt(s)}})),Zt=()=>zt((()=>lt({}))),_t=()=>zt((()=>gt({}))),es=()=>zt((()=>{rt({}),e=!1})),ts=()=>zt((()=>{at({}),t=!1})),ss=(e,t)=>{if(-1!=o){ns();const s=e();return os(t),s}},ns=()=>(-1!=o&&o++,1==o&&Be(je,void 0,!1,!1),rs),os=e=>{if(o>0&&(o--,0==o)){s=!ee(m),n=!ee(x),o=1,xt(1),s&&Ft(1),Dt(1),n&&Qt(1);let t=!e&&ee(Oe[0])&&ee(Oe[1])?[{},{},{},{}]:[ue(m,(e=>ue(e,(e=>ue(e,(e=>[...e]),(([e,t])=>e===t))),Ae)),Ae),ue(D,(e=>ue(e,ue))),ue(x,(e=>[...e]),(([e,t])=>e===t)),ue(A)];e?.(...t)&&(ne(m,((e,t)=>ne(e,((e,s)=>ne(e,(([e],n)=>Se(rs,t,s,n,e))))))),ne(x,(([e],t)=>we(rs,t,e))),s=n=!1,t=[{},{},{},{}]),Be(Oe[0],void 0,s,n,...t),o=-1,xt(0),s&&Ft(0),Dt(0),n&&Qt(0),Be(Oe[1],void 0,s,n,...t),o=0,M([a,d,h,R,m,D,E,x,A],se)}return rs},rs={getContent:()=>[Nt(),$t()],getTables:Nt,getTableIds:jt,getTable:e=>ue(ie(X,b(e)),ue),getTableCellIds:e=>ae(ie(q,b(e))),getRowIds:Ot,getSortedRowIds:Pt,getRow:(e,t)=>ue(ie(ie(X,b(e)),b(t))),getCellIds:Bt,getCell:Wt,getValues:$t,getValueIds:qt,getValue:Gt,hasTables:()=>!ee(X),hasTable:e=>_(X,b(e)),hasTableCell:(e,t)=>_(ie(q,b(e)),b(t)),hasRow:(e,t)=>_(ie(X,b(e)),b(t)),hasCell:(e,t,s)=>_(ie(ie(X,b(e)),b(t)),b(s)),hasValues:()=>!ee(Y),hasValue:e=>_(Y,b(e)),getTablesJson:()=>O(X),getValuesJson:()=>O(Y),getJson:()=>O([X,Y]),getTablesSchemaJson:()=>O(F),getValuesSchemaJson:()=>O(j),getSchemaJson:()=>O([F,j]),setContent:([e,t])=>zt((()=>{Ht(e),Kt(t)})),setTables:Ht,setTable:(e,t)=>zt((e=>Ze(t,e)?ct(e,t):0),e),setRow:(e,t,s)=>zt(((e,t)=>_e(e,t,s)?dt(e,wt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>ss((()=>{let n;return _e(e,n,t)&&(e=b(e),dt(e,wt(e),n=St(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>zt(((e,t)=>{if(_e(e,t,s,1)){const n=wt(e);De(s,((s,o)=>ht(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>zt(((e,t,s)=>H(et(e,t,s,U(n)?n(Wt(e,t,s)):n),(n=>ht(e,wt(e),t,s,n)))),e,t,s),setValues:Kt,setPartialValues:e=>zt((()=>tt(e,1)?De(e,((e,t)=>Lt(t,e))):0)),setValue:(e,t)=>zt((e=>H(st(e,U(t)?t(Gt(e)):t),(t=>Lt(e,t)))),e),setTablesJson:Ut,setValuesJson:e=>{try{ft(P(e))}catch{}return rs},setJson:e=>{try{const[t,s]=P(e);it(t),ft(s)}catch{Ut(e)}return rs},setTablesSchema:Xt,setValuesSchema:Yt,setSchema:(e,t)=>zt((()=>{Xt(e),Yt(t)})),delTables:Zt,delTable:e=>zt((e=>_(X,e)?Rt(e):0),e),delRow:(e,t)=>zt(((e,t)=>H(ie(X,e),(s=>_(s,t)?vt(e,s,t):0))),e,t),delCell:(e,t,s,n)=>zt(((e,t,s)=>H(ie(X,e),(o=>H(ie(o,t),(r=>_(r,s)?Tt(e,o,t,r,s,n):0))))),e,t,s),delValues:_t,delValue:e=>zt((e=>_(Y,e)?pt(e):0),e),delTablesSchema:es,delValuesSchema:ts,delSchema:()=>zt((()=>{es(),ts()})),transaction:ss,startTransaction:ns,finishTransaction:os,forEachTable:e=>ne(X,((t,s)=>e(s,(e=>ne(t,((t,s)=>e(s,(e=>le(t,e))))))))),forEachTableCell:(e,t)=>le(ie(q,b(e)),t),forEachRow:(e,t)=>ne(ie(X,b(e)),((e,s)=>t(s,(t=>le(e,t))))),forEachCell:(e,t,s)=>le(ie(ie(X,b(e)),b(t)),s),forEachValue:e=>le(Y,e),addSortedRowIdsListener:(e,t,s,n,o,r,a)=>{let i=Pt(e,t,s,n,o);return Pe((()=>{const a=Pt(e,t,s,n,o);V(a,i)||(i=a,r(rs,e,t,s,n,o,i))}),Ie[a?1:0],[e,t],[jt])},addStartTransactionListener:e=>Pe(e,je),addWillFinishTransactionListener:e=>Pe(e,Oe[0]),addDidFinishTransactionListener:e=>Pe(e,Oe[1]),callListener:e=>(Xe(e),rs),delListener:e=>(Ue(e),rs),getListenerStats:()=>({}),createStore:Ke};return De({[g]:[0,Z],[L]:[0,te],[f]:[1,ge,[jt]],[f+T]:[1,Te,[jt]],[w]:[1,pe,[jt]],[S]:[2,Ce,[jt,Ot]],[T]:[2,me,[jt,Ot]],[v]:[3,Ve,[jt,Ot,Bt],e=>We(Wt(...e))],InvalidCell:[3,Ee],[I]:[0,Fe],[C]:[0,ze],[p]:[1,Ne,[qt],e=>We(Gt(e[0]))],InvalidValue:[1,Me]},(([e,t,s,n],o)=>{rs[u+o+c]=(...o)=>Pe(o[e],t[o[e+1]?1:0],e>0?Q(o,0,e):void 0,s,n)})),ke(rs)};e.createCheckpoints=Fe,e.createCustomPersister=(e,t,n,o,r)=>{let a,i,l=0,c=!1;const d={load:async(n,o)=>{if(2!=l){l=1;const r=await t();G(r)||r==s?e.setContent([n,o]):e.setJson(r),l=0}return d},startAutoLoad:async(t,s)=>(d.stopAutoLoad(),await d.load(t,s),c=!0,i=o((async t=>{G(t)?await d.load():2!=l&&(l=1,e.setContent(t),l=0)})),d),stopAutoLoad:()=>(c&&(r(i),i=void 0,c=!1),d),save:async()=>(1!=l&&(l=2,await n(e.getContent),l=0),d),startAutoSave:async()=>(await d.stopAutoSave().save(),a=e.addDidFinishTransactionListener(d.save),d),stopAutoSave:()=>(H(a,e.delListener),d),getStore:()=>e,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ke(d)},e.createIndexes=ze,e.createMetrics=Oe,e.createQueries=Pe,e.createRelationships=Be,e.createStore=Ke,e.defaultSorter=Qe},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
