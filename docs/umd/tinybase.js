var e,t;e=this,t=function(e,t){"use strict";const s=e=>typeof e,n="",o=s(n),a=s(!0),r=s(0),i=s(s),l="type",c="default",d="utf8",u="Listener",h="Result",f="add",g="Ids",L="Table",w=L+"s",v=L+g,S="Row",T=S+g,p="Sorted"+S+g,R="Cell",y=R+g,I="Value",b=I+"s",m=I+g,C=e=>n+e,V=(e,t)=>e.includes(t),E=(e,t)=>e.every(t),k=(e,t)=>F(e)===F(t)&&E(e,((e,s)=>t[s]===e)),J=(e,t)=>E(e,((s,n)=>0==n||t(e[n-1],s)<=0)),M=(e,t)=>e.sort(t),x=(e,t)=>e.forEach(t),A=(e,t)=>e.map(t),D=e=>Q(e,((e,t)=>e+t),0),F=e=>e.length,P=e=>0==F(e),Q=(e,t,s)=>e.reduce(t,s),j=(e,t,s)=>e.slice(t,s),z=(e,...t)=>e.push(...t),N=e=>e.pop(),O=e=>e.shift(),B=e=>JSON.stringify(e,((e,t)=>G(t,Map)?Q([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),W=JSON.parse,q=Math.max,H=Math.min,$=isFinite,G=(e,t)=>e instanceof t,K=e=>null==e,U=(e,t,s)=>K(e)?s?.():t(e),X=e=>e==o||e==a,Y=e=>s(e)==i,Z=e=>Array.isArray(e),_=()=>{},ee=e=>e.size,te=(e,t)=>e?.has(t)??!1,se=e=>K(e)||0==ee(e),ne=e=>[...e?.values()??[]],oe=e=>e.clear(),ae=(e,t)=>e?.forEach(t),re=(e,t)=>e?.delete(t),ie=e=>new Map(e),le=e=>[...e?.keys()??[]],ce=(e,t)=>e?.get(t),de=(e,t)=>ae(e,((e,s)=>t(s,e))),ue=(e,t,s)=>K(s)?(re(e,t),e):e?.set(t,s),he=(e,t,s)=>(te(e,t)||ue(e,t,s()),ce(e,t)),fe=(e,t,s)=>{const n={},o=t??(e=>e);return ae(e,((e,t)=>U(o(e),(e=>s?.(e)?0:n[t]=e)))),n},ge=(e,t)=>{const s=ie(),n=t??(e=>e);return ae(e,((e,t)=>s.set(t,n(e)))),s},Le=e=>ge(e,ge),we=(e,t,s,n,o=0)=>U((s?he:ce)(e,t[o],o>F(t)-2?s:ie),(a=>{if(o>F(t)-2)return n?.(a)&&ue(e,t[o]),a;const r=we(a,t,s,n,o+1);return se(a)&&ue(e,t[o]),r})),ve=e=>{const t=s(e);return X(t)||t==r&&$(e)?t:void 0},Se=(e,t,s,n,o)=>K(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),Te=(e,t,s)=>K(s)?e.delValue(t):e.setValue(t,s),pe=e=>new Set(Z(e)||K(e)?e:[e]),Re=(e,t)=>e?.add(t),ye=(e,t,s)=>{const n=e.hasRow,o=ie(),a=ie(),r=ie(),i=ie(),l=ie(),c=(t,s,...n)=>{const o=he(l,t,pe);return x(n,(t=>Re(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>U(ce(l,t),(n=>{x(P(s)?ne(n):s,(t=>{e.delListener(t),re(n,t)})),se(n)&&ue(l,t)})),u=(e,s)=>{ue(o,e,s),te(a,e)||(ue(a,e,t()),ue(r,e,ie()),ue(i,e,ie()))},h=e=>{ue(o,e),ue(a,e),ue(r,e),ue(i,e),d(e)};return[()=>e,()=>le(o),e=>de(a,e),e=>te(a,e),e=>ce(o,e),e=>ce(a,e),(e,t)=>ue(a,e,t),u,(t,o,a,l,h)=>{u(t,o);const f=ie(),g=ie(),L=ce(r,t),w=ce(i,t),v=t=>{const a=s=>e.getCell(o,t,s),r=ce(L,t),i=n(o,t)?s(l(a,t)):void 0;if(r===i||Z(r)&&Z(i)&&k(r,i)||ue(f,t,[r,i]),!K(h)){const e=ce(w,t),s=n(o,t)?h(a,t):void 0;e!=s&&ue(g,t,s)}},S=e=>{a((()=>{ae(f,(([,e],t)=>ue(L,t,e))),ae(g,((e,t)=>ue(w,t,e)))}),f,g,L,w,e),oe(f),oe(g)};de(L,v),e.hasTable(o)&&x(e.getRowIds(o),(e=>{te(L,e)||v(e)})),S(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>v(s))),e.addTableListener(o,(()=>S())))},h,()=>de(l,h),c,d]},Ie=(e,t)=>s(e)==o?t=>t(e):e??(()=>t??n),be=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},me=/^\d+$/,Ce=()=>{const e=[];let t=0;return[s=>(s?O(e):null)??n+t++,t=>{me.test(t)&&F(e)<1e3&&z(e,t)}]},Ve=e=>{let t;const[s,o]=Ce(),a=ie();return[(o,r,i,l=[],c=(()=>[]))=>{t??=e();const d=s(1);return ue(a,d,[o,r,i,l,c]),Re(we(r,i??[n],pe),d),d},(e,s,...o)=>x(((e,t=[n])=>{const s=[],o=(e,n)=>n==F(t)?z(s,e):null===t[n]?ae(e,(e=>o(e,n+1))):x([t[n],null],(t=>o(ce(e,t),n+1)));return o(e,0),s})(e,s),(e=>ae(e,(e=>ce(a,e)[0](t,...s??[],...o))))),e=>U(ce(a,e),(([,t,s])=>(we(t,s??[n],void 0,(t=>(re(t,e),se(t)?1:0))),ue(a,e),o(e),s))),e=>U(ce(a,e),(([e,,s=[],n,o])=>{const a=(...r)=>{const i=F(r);i==F(s)?e(t,...r,...o(r)):K(s[i])?x(n[i]?.(...r)??[],(e=>a(...r,e))):a(...r,s[i])};a()}))]},Ee=Object,ke=Ee.keys,Je=Ee.isFrozen,Me=Ee.freeze,xe=e=>G(e,Ee)&&e.constructor==Ee,Ae=(e,t)=>!K(((e,t)=>U(e,(e=>e[t])))(e,t)),De=(e,t)=>delete e[t],Fe=(e,t)=>A(Ee.entries(e),(([e,s])=>t(s,e))),Pe=e=>xe(e)&&P(ke(e)),Qe=be((e=>{let t,s,o,a=100,r=ie(),i=ie(),l=1;const c=ie(),d=ie(),[u,h,f]=Ve((()=>Q)),g=ie(),L=ie(),w=[],v=[],S=(t,s)=>{l=0,e.transaction((()=>{const[n,o]=ce(g,s);ae(n,((s,n)=>ae(s,((s,o)=>ae(s,((s,a)=>Se(e,n,o,a,s[t]))))))),ae(o,((s,n)=>Te(e,n,s[t])))})),l=1},T=e=>{ue(g,e),ue(L,e),h(d,[e])},p=(e,t)=>x(((e,t)=>e.splice(0,t))(e,t??F(e)),T),R=()=>p(w,F(w)-a),y=()=>U(t,(()=>{z(w,t),R(),p(v),t=void 0,o=1})),I=()=>{t=N(w),o=1},b=e.addCellListener(null,null,null,((e,t,s,n,o,a)=>{if(l){y();const e=he(r,t,ie),i=he(e,s,ie),l=he(i,n,(()=>[a,void 0]));l[1]=o,l[0]===o&&se(ue(i,n))&&se(ue(e,s))&&se(ue(r,t))&&I(),J()}})),m=e.addValueListener(null,((e,t,s,n)=>{if(l){y();const e=he(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&se(ue(i,t))&&I(),J()}})),C=(e="")=>(K(t)&&(t=n+s++,ue(g,t,[r,i]),A(t,e),r=ie(),i=ie(),o=1),t),E=()=>{P(w)||(((e,...t)=>{e.unshift(...t)})(v,C()),S(0,t),t=N(w),o=1)},k=()=>{P(v)||(z(w,t),t=O(v),S(1,t),o=1)},J=()=>{o&&(h(c),o=0)},M=e=>{const t=C(e);return J(),t},A=(e,t)=>(D(e)&&ce(L,e)!==t&&(ue(L,e,t),h(d,[e])),Q),D=e=>te(g,e),Q={setSize:e=>(a=e,R(),Q),addCheckpoint:M,setCheckpoint:A,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...v]],forEachCheckpoint:e=>de(L,e),hasCheckpoint:D,getCheckpoint:e=>ce(L,e),goBackward:()=>(E(),J(),Q),goForward:()=>(k(),J(),Q),goTo:e=>{const s=V(w,e)?E:V(v,e)?k:null;for(;!K(s)&&e!=t;)s();return J(),Q},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(f(e),Q),clear:()=>(p(w),p(v),K(t)||T(t),t=void 0,s=0,M(),Q),destroy:()=>{e.delListener(b),e.delListener(m)},getListenerStats:()=>({})};return Me(Q.clear())})),je=(e,t)=>e<t?-1:1,ze=be((e=>{const t=ie(),s=ie(),[o,a,r,i,l,c,d,,u,h,f]=ye(e,ie,(e=>K(e)?n:Z(e)?A(e,C):C(e))),[g,L,w]=Ve((()=>S)),v=(t,s,n)=>{const o=l(t);ae(n,((t,n)=>s(n,(s=>ae(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},S={setIndexDefinition:(e,n,o,a,r,i=je)=>{const l=K(r)?void 0:([e],[t])=>r(e,t);return u(e,n,((n,o,r,u,h,f)=>{let g=0;const w=pe(),v=pe(),S=c(e);if(ae(o,(([e,t],s)=>{const n=pe(e),o=pe(t);ae(n,(e=>re(o,e)?re(n,e):0)),ae(n,(e=>{Re(w,e),U(ce(S,e),(t=>{re(t,s),se(t)&&(ue(S,e),g=1)}))})),ae(o,(e=>{Re(w,e),te(S,e)||(ue(S,e,pe()),g=1),Re(ce(S,e),s),K(a)||Re(v,e)}))})),n(),se(h)||(f?de(S,(e=>Re(v,e))):de(r,(e=>U(ce(u,e),(e=>Re(v,e))))),ae(v,(e=>{const t=(t,s)=>i(ce(h,t),ce(h,s),e),s=[...ce(S,e)];J(s,t)||(ue(S,e,pe(M(s,t))),Re(w,e))}))),(g||f)&&!K(l)){const t=[...S];J(t,l)||(d(e,ie(M(t,l))),g=1)}g&&L(t,[e]),ae(w,(t=>L(s,[e,t])))}),Ie(o),U(a,Ie)),S},delIndexDefinition:e=>(h(e),S),getStore:o,getIndexIds:a,forEachIndex:e=>r(((t,s)=>e(t,(e=>v(t,e,s))))),forEachSlice:(e,t)=>v(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>te(c(e),t),getTableId:l,getSliceIds:e=>le(c(e)),getSliceRowIds:(e,t)=>ne(ce(c(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,n)=>g(n,s,[e,t]),delListener:e=>(w(e),S),destroy:f,getListenerStats:()=>({})};return Me(S)})),Ne=ie([["avg",[(e,t)=>D(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>q(...e),(e,t)=>q(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:q(t,e)]],["min",[e=>H(...e),(e,t)=>H(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:H(t,e)]],["sum",[e=>D(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Oe=(e,t,s,n,o,a=!1)=>{if(se(s))return;const[r,i,l,c]=o;return a||=K(e),ae(n,(([s,n])=>{a||(e=K(s)?i?.(e,n,t++):K(n)?l?.(e,s,t--):c?.(e,n,s,t),a||=K(e))})),a?r(ne(s),ee(s)):e},Be=be((e=>{const t=ie(),[s,o,a,r,i,l,c,,d,u,h]=ye(e,_,(e=>isNaN(e)||K(e)||!0===e||!1===e||e===n?void 0:1*e)),[f,g,L]=Ve((()=>w)),w={setMetricDefinition:(e,s,n,o,a,r,i)=>{const u=Y(n)?[n,a,r,i]:ce(Ne,n)??ce(Ne,"sum");return d(e,s,((s,n,o,a,r,i)=>{const d=l(e),h=ee(a);i||=K(d),s();let f=Oe(d,h,a,n,u,i);$(f)||(f=void 0),f!=d&&(c(e,f),g(t,[e],f,d))}),Ie(o,1)),w},delMetricDefinition:e=>(u(e),w),getStore:s,getMetricIds:o,forEachMetric:a,hasMetric:r,getTableId:i,getMetric:l,addMetricListener:(e,s)=>f(s,t,[e]),delListener:e=>(L(e),w),destroy:h,getListenerStats:()=>({})};return Me(w)})),We=(e,t,s,o,a)=>{let r,i,l=0;const c={load:async(s={},o={})=>{if(2!=l){l=1;const a=await t();K(a)||a==n?e.transaction((()=>e.setTables(s).setValues(o))):e.setJson(a),l=0}return c},startAutoLoad:async(e={},t={})=>(c.stopAutoLoad(),await c.load(e,t),o(c.load),c),stopAutoLoad:()=>(a(),c),save:async()=>(1!=l&&(l=2,await s(e.getJson()),l=0),c),startAutoSave:async()=>(await c.stopAutoSave().save(),r=e.addTablesListener(c.save),i=e.addValuesListener(c.save),c),stopAutoSave:()=>(U(r,e.delListener),U(i,e.delListener),c),getStore:()=>e,destroy:()=>c.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return Me(c)},qe="storage",He=globalThis.window,$e=(e,t,s)=>{let n;return We(e,(async()=>s.getItem(t)),(async e=>s.setItem(t,e)),(e=>{n=n=>{n.storageArea===s&&n.key===t&&e()},He.addEventListener(qe,n)}),(()=>{He.removeEventListener(qe,n),n=void 0}))},Ge=e=>e.headers.get("ETag"),Ke=be((e=>{const t=e.createStore,[s,o,a,r,i,,,l,,c,d,g,w]=ye(e,(()=>!0),_),v=t(),I=t(),b=ie(),m=(e,t,...s)=>x(s,(s=>Re(he(he(b,t,ie),e,pe),s))),C=e=>{U(ce(b,e),(e=>{de(e,((e,t)=>ae(t,(t=>e.delListener(t))))),oe(e)})),x([I,v],(t=>t.delTable(e)))},V=(e,t,s)=>m(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),k={setQueryDefinition:(t,s,o)=>{l(t,s),C(t);const a=[],r=[[null,[s,null,null,[],ie()]]],i=[],c=[],d=[];o({select:(e,t)=>{const s=Y(e)?[F(a)+n,e]:[K(t)?e:t,s=>s(e,t)];return z(a,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=K(s)||Y(t)?null:t,o=K(n)?t:s,a=[e,[e,n,Y(o)?o:e=>e(o),[],ie()]];return z(r,a),{as:e=>a[0]=e}},where:(e,t,s)=>z(i,Y(e)?e:K(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const a=[e,[e,Y(t)?[t,s,n,o]:ce(Ne,t)??[(e,t)=>t]]];return z(c,a),{as:e=>a[0]=e}},having:(e,t)=>z(d,Y(e)?e:s=>s(e)===t)});const u=ie(a);if(se(u))return k;const h=ie(r);de(h,((e,[,t])=>U(ce(h,t),(({3:t})=>K(e)?0:z(t,e)))));const f=ie(c);let L=v;if(se(f)&&P(d))L=I;else{V(t,L,I);const e=ie();de(f,((t,[s,n])=>Re(he(e,s,pe),[t,n])));const s=pe();de(u,(t=>te(e,t)?0:Re(s,t)));const n=ie(),o=(s,n,o,a)=>U(s,(([r,i,l,c])=>{de(n,((t,[s])=>{const n=he(r,t,ie),i=ce(n,o),l=a?void 0:s;if(i!==l){const s=pe([[i,l]]),a=ee(n);ue(n,o,l),ae(ce(e,t),(([e,t])=>{const o=Oe(c[e],a,n,s,t);c[e]=K(ve(o))?null:o}))}})),se(i)||!E(d,(e=>e((e=>c[e]))))?I.delRow(t,l):K(l)?s[2]=I.addRow(t,c):I.setRow(t,l,c)}));m(L,t,L.addRowListener(t,null,((a,r,i,l)=>{const c=[],d=[],u=ie(),h=L.hasRow(t,i);let f=!h;ae(s,(e=>{const[s,n,o]=l(t,i,e);z(c,n),z(d,o),f||=s})),de(e,(e=>{const[s,,n]=l(t,i,e);(f||s)&&ue(u,e,[n])})),f&&o(we(n,c,void 0,(([,e])=>(re(e,i),se(e)))),u,i,1),h&&o(we(n,d,(()=>{const e={};return ae(s,(s=>e[s]=L.getCell(t,i,s))),[ie(),pe(),void 0,e]}),(([,e])=>{Re(e,i)})),u,i)})))}V(t,e,L);const S=(n,o,a,r)=>{const l=t=>e.getCell(o,a,t);x(r,(s=>{const[o,,a,r,i]=ce(h,s),c=a?.(l,n),[d,u]=ce(i,n)??[];c!=d&&(K(u)||w(t,u),ue(i,n,K(c)?null:[c,...g(t,1,e.addRowListener(o,c,(()=>S(n,o,c,r))))]))})),(n=>{const o=(t,o)=>e.getCell(...K(o)?[s,n,t]:t===s?[s,n,o]:[ce(h,t)?.[0],ce(ce(h,t)?.[4],n)?.[0],o]);L.transaction((()=>E(i,(e=>e(o)))?de(u,((e,s)=>Se(L,t,n,e,s(o,n)))):L.delRow(t,n)))})(n)},{3:T}=ce(h,null);return L.transaction((()=>g(t,1,e.addRowListener(s,null,((n,o,a)=>{e.hasRow(s,a)?S(a,s,a,T):(L.delRow(t,a),ae(h,(({4:e})=>U(ce(e,a),(([,s])=>{w(t,s),ue(e,a)})))))}))))),k},delQueryDefinition:e=>(C(e),c(e),k),getStore:s,getQueryIds:o,forEachQuery:a,hasQuery:r,getTableId:i,delListener:e=>(I.delListener(e),k),destroy:d,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=I.getListenerStats();return n}};return Fe({[L]:[1,1],[T]:[0,1],[p]:[0,5],[S]:[1,2],[y]:[0,2],[R]:[1,3]},(([e,t],s)=>{x(e?["get","has","forEach"]:["get"],(e=>k[e+h+s]=(...t)=>I[e+s](...t))),k[f+h+s+u]=(...e)=>I[f+s+u](...j(e,0,t),((s,...n)=>e[t](k,...n)))})),Me(k)})),Ue=be((e=>{const t=ie(),s=ie(),o=ie(),a=ie(),[r,i,l,c,d,u,,,h,f,g]=ye(e,(()=>[ie(),ie(),ie(),ie()]),(e=>K(e)?void 0:e+n)),[L,w,v]=Ve((()=>R)),S=(e,t,s)=>U(u(e),(([n,,o])=>{if(!te(o,t)){const a=pe();if(d(e)!=p(e))Re(a,t);else{let e=t;for(;!K(e)&&!te(a,e);)Re(a,e),e=ce(n,e)}if(s)return a;ue(o,t,a)}return ce(o,t)})),T=(e,t)=>U(u(e),(([,,e])=>ue(e,t))),p=e=>ce(t,e),R={setRelationshipDefinition:(e,n,r,i)=>(ue(t,e,r),h(e,n,((t,n)=>{const r=pe(),i=pe(),l=pe(),[c,d]=u(e);ae(n,(([t,s],n)=>{K(t)||(Re(i,t),U(ce(d,t),(e=>{re(e,n),se(e)&&ue(d,t)}))),K(s)||(Re(i,s),te(d,s)||ue(d,s,pe()),Re(ce(d,s),n)),Re(r,n),ue(c,n,s),de(ce(a,e),(t=>{te(S(e,t),n)&&Re(l,t)}))})),t(),ae(r,(t=>w(s,[e,t]))),ae(i,(t=>w(o,[e,t]))),ae(l,(t=>{T(e,t),w(a,[e,t])}))}),Ie(i)),R),delRelationshipDefinition:e=>(ue(t,e),f(e),R),getStore:r,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:p,getRemoteRowId:(e,t)=>ce(u(e)?.[0],t),getLocalRowIds:(e,t)=>ne(ce(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>K(u(e))?[t]:ne(S(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>L(n,s,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(S(e,t),L(s,a,[e,t])),delListener:e=>(T(...v(e)),R),destroy:g,getListenerStats:()=>({})};return Me(R)})),Xe=e=>[e,e],Ye=()=>[ie(),ie()],Ze=(e,t,s,n=ue)=>(Fe(t,((t,n)=>s(e,n,t))),de(e,(s=>Ae(t,s)?0:n(e,s))),e),_e=(e,t,s)=>K(e)||!xe(e)||Pe(e)||Je(e)?(s?.(),!1):(Fe(e,((s,n)=>{t(s,n)||De(e,n)})),!Pe(e)),et=(e,t,s)=>ue(e,t,ce(e,t)==-s?void 0:s),tt=()=>{let e,t,s,n,o=0;const a=ie(),i=ie(),d=ie(),h=ie(),g=ie(),p=ie(),E=ie(),J=ie(),D=ie(),F=ie(),P=ie(),Q=ie(),N=ie(),O=pe(),q=ie(),H=ie(),$=ie(),G=ie(),Z=Ye(),_=Ye(),ee=Ye(),ne=Ye(),we=Ye(),ye=Ye(),Ie=Ye(),be=Ye(),me=Ye(),Ee=Ye(),ke=Ye(),Je=Ye(),xe=Ye(),Qe=Ye(),ze=ie(),Ne=Ye(),[Oe,Be,We,qe]=Ve((()=>as)),He=e=>{if(!_e(e,((e,t)=>V([l,c],t))))return!1;const t=e[l];return!(!X(t)&&t!=r||(ve(e[c])!=t&&De(e,c),0))},$e=(t,s)=>(!e||te(F,s)||Et(s))&&_e(t,((e,t)=>Ge(s,t,e)),(()=>Et(s))),Ge=(e,t,s,n)=>_e(n?s:nt(s,e,t),((n,o)=>U(Ke(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Et(e,t))),Ke=(t,s,n,o)=>e?U(ce(ce(F,t),n),(e=>ve(o)!=e[l]?Et(t,s,n,o,e[c]):o),(()=>Et(t,s,n,o))):K(ve(o))?Et(t,s,n,o):o,Ue=(e,t)=>_e(t?e:ot(e),((t,s)=>U(st(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>kt())),st=(e,s)=>t?U(ce(Q,e),(t=>ve(s)!=t[l]?kt(e,s,t[c]):s),(()=>kt(e,s))):K(ve(s))?kt(e,s):s,nt=(e,t,s)=>(U(ce(P,t),(([n,o])=>{ae(n,((t,s)=>{Ae(e,s)||(e[s]=t)})),ae(o,(n=>{Ae(e,n)||Et(t,s,n)}))})),e),ot=e=>(t&&(ae(N,((t,s)=>{Ae(e,s)||(e[s]=t)})),ae(O,(t=>{Ae(e,t)||kt(t)}))),e),at=e=>Ze(F,e,((e,t,s)=>{const n=ie(),o=pe();Ze(he(F,t,ie),s,((e,t,s)=>{ue(e,t,s),U(s[c],(e=>ue(n,t,e)),(()=>Re(o,t)))})),ue(P,t,[n,o])}),((e,t)=>{ue(F,t),ue(P,t)})),rt=e=>Ze(Q,e,((e,t,s)=>{ue(Q,t,s),U(s[c],(e=>ue(N,t,e)),(()=>Re(O,t)))}),((e,t)=>{ue(Q,t),ue(N,t),re(O,t)})),it=e=>Pe(e)?Zt():Gt(e),lt=e=>Ze($,e,((e,t,s)=>ct(t,s)),((e,t)=>St(t))),ct=(e,t)=>Ze(he($,e,(()=>(yt(e,1),ue(q,e,Ce()),ue(H,e,ie()),ie()))),t,((t,s,n)=>dt(e,t,s,n)),((t,s)=>Tt(e,t,s))),dt=(e,t,s,n,o)=>Ze(he(t,s,(()=>(It(e,s,1),ie()))),n,((t,n,o)=>ut(e,s,t,n,o)),((n,a)=>pt(e,t,s,n,a,o))),ut=(e,t,s,n,o)=>{te(s,n)||bt(e,t,n,1);const a=ce(s,n);o!==a&&(mt(e,t,n,a,o),ue(s,n,o))},ht=(e,t,s,n,o)=>U(ce(t,s),(t=>ut(e,s,t,n,o)),(()=>dt(e,t,s,nt({[n]:o},e,s)))),ft=e=>Pe(e)?_t():Kt(e),gt=e=>Ze(G,e,((e,t,s)=>Lt(t,s)),((e,t)=>Rt(t))),Lt=(e,t)=>{te(G,e)||Ct(e,1);const s=ce(G,e);t!==s&&(Vt(e,s,t),ue(G,e,t))},wt=(e,t)=>{const[s]=ce(q,e),n=s(t);return te(ce($,e),n)?wt(e,t):n},vt=e=>ce($,e)??ct(e,{}),St=e=>ct(e,{}),Tt=(e,t,s)=>{const[,n]=ce(q,e);n(s),dt(e,t,s,{},!0)},pt=(e,t,s,n,o,a)=>{const r=ce(ce(P,e)?.[0],o);if(!K(r)&&!a)return ut(e,s,n,o,r);const i=t=>{mt(e,s,t,ce(n,t)),bt(e,s,t,-1),ue(n,t)};K(r)?i(o):de(n,i),se(n)&&(It(e,s,-1),se(ue(t,s))&&(yt(e,-1),ue($,e),ue(q,e),ue(H,e)))},Rt=e=>{const t=ce(N,e);if(!K(t))return Lt(e,t);Vt(e,ce(G,e)),Ct(e,-1),ue(G,e)},yt=(e,t)=>et(a,e,t),It=(e,t,s)=>et(he(d,e,ie),t,s),bt=(e,t,s,n)=>{const o=ce(H,e),a=ce(o,s)??0;(0==a&&1==n||1==a&&-1==n)&&et(he(i,e,ie),s,n),ue(o,s,a!=-n?a+n:null),et(he(he(h,e,ie),t,ie),s,n)},mt=(e,t,s,n,o)=>he(he(he(g,e,ie),t,ie),s,(()=>[n,0]))[1]=o,Ct=(e,t)=>et(p,e,t),Vt=(e,t,s)=>he(E,e,(()=>[t,0]))[1]=s,Et=(e,t,s,n,o)=>(z(he(he(he(J,e,ie),t,ie),s,(()=>[])),n),o),kt=(e,t,s)=>(z(he(D,e,(()=>[])),t),s),Jt=(e,t,s)=>U(ce(ce(ce(g,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Xe(Wt(e,t,s))])),Mt=e=>U(ce(E,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Xe($t(e))])),xt=e=>se(J)||se(Ee[e])?0:ae(e?ge(J,Le):J,((t,s)=>ae(t,((t,n)=>ae(t,((t,o)=>Be(Ee[e],[s,n,o],t))))))),At=e=>se(D)||se(ke[e])?0:ae(e?ge(D):D,((t,s)=>Be(ke[e],[s],t))),Dt=(e,t,s)=>{if(!se(t))return Be(e,s,(()=>fe(t))),1},Ft=e=>{const t=se(ye[e]),s=se(be[e])&&se(ne[e])&&se(we[e])&&t&&se(_[e]),n=se(me[e])&&se(Ie[e])&&se(ee[e])&&se(Z[e]);if(!s||!n){const o=e?[ge(a),Le(i),Le(d),ge(h,Le),ge(g,Le)]:[a,i,d,h,g];if(!s){ae(o[1],((t,s)=>Dt(ne[e],t,[s]))),ae(o[3],((t,s)=>ae(t,((t,n)=>Dt(be[e],t,[s,n])))));const s=pe();ae(o[2],((n,o)=>{Dt(we[e],n,[o])&&!t&&(Be(ye[e],[o,null]),Re(s,o))})),t||ae(o[4],((t,n)=>{if(!te(s,n)){const s=pe();ae(t,(e=>ae(e,(([t,n],o)=>n!==t?Re(s,o):re(e,o))))),ae(s,(t=>Be(ye[e],[n,t])))}})),Dt(_[e],o[0])}if(!n){let t;ae(o[4],((s,n)=>{let o;ae(s,((s,a)=>{let r;ae(s,(([s,i],l)=>{i!==s&&(Be(me[e],[n,a,l],i,s,Jt),t=o=r=1)})),r&&Be(Ie[e],[n,a],Jt)})),o&&Be(ee[e],[n],Jt)})),t&&Be(Z[e],void 0,Jt)}}},Pt=e=>{const t=se(xe[e]),s=se(Qe[e])&&se(Je[e]);if(!t||!s){const n=e?[ge(p),ge(E)]:[p,E];if(t||Dt(xe[e],n[0]),!s){let t;ae(n[1],(([s,n],o)=>{n!==s&&(Be(Qe[e],[o],n,s,Mt),t=1)})),t&&Be(Je[e],void 0,Mt)}}},Qt=(e,...t)=>(ss((()=>e(...A(t,C)))),as),jt=()=>fe($,(e=>fe(e,fe))),zt=()=>le($),Nt=e=>le(ce($,C(e))),Ot=(e,t,s,n=0,o)=>{return A(j(M((a=ce($,C(e)),r=(e,s)=>[K(t)?s:ce(e,C(t)),s],A([...a?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,K(o)?o:n+o),(([,e])=>e));var a,r},Bt=(e,t)=>le(ce(ce($,C(e)),C(t))),Wt=(e,t,s)=>ce(ce(ce($,C(e)),C(t)),C(s)),qt=()=>fe(G),Ht=()=>le(G),$t=e=>ce(G,C(e)),Gt=e=>Qt((()=>(e=>_e(e,$e,Et))(e)?lt(e):0)),Kt=e=>Qt((()=>Ue(e)?gt(e):0)),Ut=e=>{try{it(W(e))}catch{}return as},Xt=t=>Qt((()=>{if((e=_e(t,(e=>_e(e,He))))&&(at(t),!se($))){const e=jt();Zt(),Gt(e)}})),Yt=e=>Qt((()=>{if(t=(e=>_e(e,He))(e)){const s=qt();ts(),_t(),t=!0,rt(e),Kt(s)}})),Zt=()=>Qt((()=>lt({}))),_t=()=>Qt((()=>gt({}))),es=()=>Qt((()=>{at({}),e=!1})),ts=()=>Qt((()=>{rt({}),t=!1})),ss=(e,t)=>{if(-1!=o){ns();const s=e();return os(t),s}},ns=()=>(-1!=o&&o++,1==o&&Be(ze,void 0,!1,!1),as),os=e=>(o>0&&(o--,0==o&&(s=!se(g),n=!se(E),o=1,xt(1),s&&Ft(1),At(1),n&&Pt(1),e?.(fe(g,(e=>fe(e,(e=>fe(e,(e=>[...e]),(([e,t])=>e===t))),Pe)),Pe),fe(J,(e=>fe(e,fe))),fe(E,(e=>[...e]),(([e,t])=>e===t)),fe(D))&&(ae(g,((e,t)=>ae(e,((e,s)=>ae(e,(([e],n)=>Se(as,t,s,n,e))))))),ae(E,(([e],t)=>Te(as,t,e))),s=n=!1),Be(Ne[0],void 0,s,n),o=-1,xt(0),s&&Ft(0),At(0),n&&Pt(0),Be(Ne[1],void 0,s,n),o=0,x([a,i,d,h,g,J,p,E,D],oe))),as),as={getTables:jt,getTableIds:zt,getTable:e=>fe(ce($,C(e)),fe),getTableCellIds:e=>le(ce(H,C(e))),getRowIds:Nt,getSortedRowIds:Ot,getRow:(e,t)=>fe(ce(ce($,C(e)),C(t))),getCellIds:Bt,getCell:Wt,getValues:qt,getValueIds:Ht,getValue:$t,hasTables:()=>!se($),hasTable:e=>te($,C(e)),hasTableCell:(e,t)=>te(ce(H,C(e)),C(t)),hasRow:(e,t)=>te(ce($,C(e)),C(t)),hasCell:(e,t,s)=>te(ce(ce($,C(e)),C(t)),C(s)),hasValues:()=>!se(G),hasValue:e=>te(G,C(e)),getTablesJson:()=>B($),getValuesJson:()=>B(G),getJson:()=>B([$,G]),getTablesSchemaJson:()=>B(F),getValuesSchemaJson:()=>B(Q),getSchemaJson:()=>B([F,Q]),setTables:Gt,setTable:(e,t)=>Qt((e=>$e(t,e)?ct(e,t):0),e),setRow:(e,t,s)=>Qt(((e,t)=>Ge(e,t,s)?dt(e,vt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>ss((()=>{let n;return Ge(e,n,t)&&(e=C(e),dt(e,vt(e),n=wt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Qt(((e,t)=>{if(Ge(e,t,s,1)){const n=vt(e);Fe(s,((s,o)=>ht(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Qt(((e,t,s)=>U(Ke(e,t,s,Y(n)?n(Wt(e,t,s)):n),(n=>ht(e,vt(e),t,s,n)))),e,t,s),setValues:Kt,setPartialValues:e=>Qt((()=>Ue(e,1)?Fe(e,((e,t)=>Lt(t,e))):0)),setValue:(e,t)=>Qt((e=>U(st(e,Y(t)?t($t(e)):t),(t=>Lt(e,t)))),e),setTablesJson:Ut,setValuesJson:e=>{try{ft(W(e))}catch{}return as},setJson:e=>{try{const[t,s]=W(e);it(t),ft(s)}catch{Ut(e)}return as},setTablesSchema:Xt,setValuesSchema:Yt,setSchema:(e,t)=>Qt((()=>{Xt(e),Yt(t)})),delTables:Zt,delTable:e=>Qt((e=>te($,e)?St(e):0),e),delRow:(e,t)=>Qt(((e,t)=>U(ce($,e),(s=>te(s,t)?Tt(e,s,t):0))),e,t),delCell:(e,t,s,n)=>Qt(((e,t,s)=>U(ce($,e),(o=>U(ce(o,t),(a=>te(a,s)?pt(e,o,t,a,s,n):0))))),e,t,s),delValues:_t,delValue:e=>Qt((e=>te(G,e)?Rt(e):0),e),delTablesSchema:es,delValuesSchema:ts,delSchema:()=>Qt((()=>{es(),ts()})),transaction:ss,startTransaction:ns,finishTransaction:os,forEachTable:e=>ae($,((t,s)=>e(s,(e=>ae(t,((t,s)=>e(s,(e=>de(t,e))))))))),forEachTableCell:(e,t)=>de(ce(H,C(e)),t),forEachRow:(e,t)=>ae(ce($,C(e)),((e,s)=>t(s,(t=>de(e,t))))),forEachCell:(e,t,s)=>de(ce(ce($,C(e)),C(t)),s),forEachValue:e=>de(G,e),addSortedRowIdsListener:(e,t,s,n,o,a,r)=>{let i=Ot(e,t,s,n,o);return Oe((()=>{const r=Ot(e,t,s,n,o);k(r,i)||(i=r,a(as,e,t,s,n,o,i))}),ye[r?1:0],[e,t],[zt])},addStartTransactionListener:e=>Oe(e,ze),addWillFinishTransactionListener:e=>Oe(e,Ne[0]),addDidFinishTransactionListener:e=>Oe(e,Ne[1]),callListener:e=>(qe(e),as),delListener:e=>(We(e),as),getListenerStats:()=>({}),createStore:tt};return Fe({[w]:[0,Z],[v]:[0,_],[L]:[1,ee,[zt]],[L+y]:[1,ne,[zt]],[T]:[1,we,[zt]],[S]:[2,Ie,[zt,Nt]],[y]:[2,be,[zt,Nt]],[R]:[3,me,[zt,Nt,Bt],e=>Xe(Wt(...e))],InvalidCell:[3,Ee],[b]:[0,Je],[m]:[0,xe],[I]:[1,Qe,[Ht],e=>Xe($t(e[0]))],InvalidValue:[1,ke]},(([e,t,s,n],o)=>{as[f+o+u]=(...o)=>Oe(o[e],t[o[e+1]?1:0],e>0?j(o,0,e):void 0,s,n)})),Me(as)};e.createCheckpoints=Qe,e.createCustomPersister=We,e.createFilePersister=(e,s)=>{let n;return We(e,(async()=>{try{return await t.promises.readFile(s,d)}catch{}}),(async e=>{try{await t.promises.writeFile(s,e,d)}catch{}}),(e=>{n=t.watch(s,e)}),(()=>{n?.close(),n=void 0}))},e.createIndexes=ze,e.createLocalPersister=(e,t)=>$e(e,t,localStorage),e.createMetrics=Be,e.createQueries=Ke,e.createRelationships=Ue,e.createRemotePersister=(e,t,s,n)=>{let o,a;return We(e,(async()=>{const e=await fetch(t);return a=Ge(e),e.text()}),(async e=>await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:e})),(e=>{o=setInterval((async()=>{const s=await fetch(t,{method:"HEAD"}),n=Ge(s);K(a)||K(n)||n==a||(a=n,e())}),1e3*n)}),(()=>{U(o,clearInterval),o=void 0}))},e.createSessionPersister=(e,t)=>$e(e,t,sessionStorage),e.createStore=tt,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={},e.fs);
