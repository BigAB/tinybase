var t,e;t=this,e=function(t){"use strict";const e=(t,e)=>t instanceof e,a=t=>null==t,s=Object,n=s.keys,o=s.freeze,r=t=>(t=>e(t,s)&&t.constructor==s)(t)&&0==(t=>n(t).length)(t),c=JSON.parse,i=t=>new Map(t),d=(t,e)=>t?.get(e),y=(t,e,s)=>{return a(s)?(n=t,o=e,n?.delete(o),t):t?.set(e,s);var n,o},u=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||y(t,e,a()),d(t,e)},f=i(),h=i(),l=t=>t.headers.get("ETag");t.createRemotePersister=(t,n,i,p,w)=>{let v;return((t,e,s,n,c,i,l=[])=>{let p,w,v,g=0,A=0;u(f,l,(()=>0)),u(h,l,(()=>[]));const S=async t=>(2!=g&&(g=1,await T.schedule((async()=>{await t(),g=0}))),T),T={load:async(a,s)=>await S((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},s={})=>(T.stopAutoLoad(),await T.load(a,s),A=1,v=n((async(a,s)=>{if(s){const e=s();await S((async()=>t.setTransactionChanges(e)))}else await S((async()=>{try{t.setContent(a?.()??await e())}catch(t){i?.(t)}}))})),T),stopAutoLoad:()=>(A&&(c(v),v=void 0,A=0),T),save:async e=>(1!=g&&(g=2,await T.schedule((async()=>{try{await s(t.getContent,e)}catch(t){i?.(t)}g=0}))),T),startAutoSave:async()=>(await T.stopAutoSave().save(),p=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();r(a)&&r(s)||T.save((()=>[a,s]))})),T),stopAutoSave:()=>{var e,s;return e=p,s=t.delListener,a(e)||s(e),T},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(d(h,l),...t),await(async()=>{if(!d(f,l)){for(y(f,l,1);!a((t=d(h,l),w=t.shift()));)try{await w()}catch(t){i?.(t)}y(f,l,0)}var t})(),T),getStore:()=>t,destroy:()=>T.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return o(T)})(t,(async()=>{const t=await fetch(n);return v=l(t),c(await t.text())}),(async t=>{return await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:(a=t(),JSON.stringify(a,((t,a)=>e(a,Map)?s.fromEntries([...a]):a)))});var a}),(t=>setInterval((async()=>{const e=await fetch(n,{method:"HEAD"}),s=l(e);a(v)||a(s)||s==v||(v=s,t())}),1e3*p)),(t=>clearInterval(t)),w)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
